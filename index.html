<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø­Ù„ Ù„Ù„Ø¬ÙˆØ§Ù„ (Ù†Ø³Ø®Ø© Ù†Ù‡Ø§Ø¦ÙŠØ©)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body {
            background: #f1f5f9;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #app {
            width: 100%;
            max-width: 450px;
            height: 100%;
            background: white;
            box-shadow: 0 0 25px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-radius: 24px 24px 0 0;
            position: relative;
        }
        .connection-status {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 2000;
            background: #1e2b3c;
            color: white;
            padding: 6px 14px;
            border-radius: 30px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .online-status { background: #27ae60; }
        .offline-status { background: #e74c3c; }
        .syncing-status { background: #3498db; }

        /* Ø§Ù„Ø±Ø£Ø³ */
        .app-header {
            background: white;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid #eef2f6;
        }
        .search-box {
            flex: 1;
            position: relative;
        }
        .search-box i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
        }
        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 1px solid #e2e8f0;
            border-radius: 40px;
            background: #f8fafc;
            font-size: 0.9rem;
        }
        .search-box input:focus {
            outline: none;
            border-color: #4a6fa5;
            background: white;
        }
        .header-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #f1f5f9;
            border: none;
            color: #2d3a4f;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.2s;
        }
        .header-btn.primary { background: #27ae60; color: white; }
        .header-btn:active { transform: scale(0.94); background: #e2e8f0; }
        /* Ø²Ø± Ø§Ù„Ø¹ÙŠÙ† */
        .eye-btn.active {
            background: #4a6fa5;
            color: white;
        }

        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª */
        .items-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px 12px;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù†ØªØ¬ */
        .product-card {
            background: white;
            border-radius: 24px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.02);
            border: 1px solid #edf2f9;
            transition: 0.2s;
        }
        .product-card.low-stock {
            border-right: 6px solid #f97316;
            background: #fffaf0;
        }
        .product-card.out-of-stock {
            border-right: 6px solid #ef4444;
            background: #fef2f2;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .product-name {
            font-weight: 700;
            font-size: 1.2rem;
            color: #1e2b3c;
        }
        .stock-badge {
            background: #eef2f6;
            padding: 6px 14px;
            border-radius: 40px;
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .stock-badge i { color: #4b7bec; }
        .profit-badge {
            background: #eef2f6;
            padding: 6px 14px;
            border-radius: 40px;
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .profit-positive { background: #dff0e4; color: #1e7b4c; }
        .profit-negative { background: #fde0dd; color: #b53b3b; }
        .price-row {
            display: flex;
            background: #f8fafd;
            border-radius: 20px;
            padding: 12px 0;
            margin: 8px 0;
            border: 1px solid #eef2f6;
        }
        .price-col {
            flex: 1;
            text-align: center;
            border-left: 1px dashed #d0d9e8;
        }
        .price-col:last-child { border-left: none; }
        .price-label {
            font-size: 0.7rem;
            color: #6f7d95;
            text-transform: uppercase;
        }
        .primary-price {
            font-weight: 800;
            font-size: 1.1rem;
        }
        .purchase-price .primary-price { color: #e55353; }
        .sale-price .primary-price { color: #2e9a5e; }
        .secondary-price {
            font-size: 0.7rem;
            color: #5f6c84;
        }
        .blur-price {
            filter: blur(5px);
            user-select: none;
        }
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .action-btn {
            flex: 1;
            padding: 12px 0;
            border: none;
            border-radius: 40px;
            font-weight: 600;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            background: #f0f4fc;
            color: #2d3a4f;
            cursor: pointer;
            transition: 0.2s;
        }
        .action-btn.sell { background: #27ae60; color: white; }
        .action-btn.sell:disabled { background: #cbd5e0; color: #94a3b8; }
        .action-btn.edit { background: #e3efff; color: #1e5f9e; }
        .action-btn.delete { background: #ffeae8; color: #c23321; }
        .action-btn.confirm-delete { background: #ef4444; color: white; }
        .action-btn.cancel-delete { background: #94a3b8; color: white; }

        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
        .stats-footer {
            background: #1e2b3c;
            color: white;
            padding: 12px 14px;
            border-radius: 30px 30px 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.15);
            display: none;
            font-size: 0.8rem; /* ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· */
        }
        .stats-footer.visible { display: block; }
        .stats-section {
            margin-bottom: 8px;
        }
        .stats-title {
            font-size: 0.7rem;
            color: #b0c4de;
            margin-bottom: 4px;
            letter-spacing: 0.5px;
        }
        .stats-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 12px 16px;
        }
        .stat-item {
            min-width: 70px;
        }
        .stat-label {
            font-size: 0.6rem;
            color: #a0b8d4;
            text-transform: uppercase;
        }
        .stat-value {
            font-weight: 700;
            font-size: 0.9rem; /* ØªØµØºÙŠØ± */
        }

        /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 12px;
        }
        .modal-content {
            background: white;
            border-radius: 36px;
            width: 100%;
            max-width: 420px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 24px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h2 { font-size: 1.4rem; color: #1e2b3c; }
        .close-modal {
            background: none; border: none; font-size: 2rem; line-height: 1; cursor: pointer; color: #94a3b8;
        }
        .form-group { margin-bottom: 18px; }
        .form-group label {
            display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.9rem;
        }
        .form-group input, .form-group select {
            width: 100%; padding: 14px 18px; border: 1px solid #dde2e9; border-radius: 24px; font-size: 1rem;
        }
        .currency-info { font-size: 0.8rem; color: #4b6584; margin-top: 5px; }
        .radio-group { display: flex; gap: 20px; }
        .form-actions { display: flex; gap: 10px; margin-top: 25px; }
        .save-btn, .cancel-btn {
            flex: 1; padding: 16px; border: none; border-radius: 40px; font-weight: bold; font-size: 1rem; cursor: pointer;
        }
        .save-btn { background: #27ae60; color: white; }
        .cancel-btn { background: #f1f5f9; color: #1e2b3c; }

        /* Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª */
        .history-tabs { display: flex; gap: 8px; margin-bottom: 15px; }
        .history-tabs button {
            flex: 1; padding: 12px; border: none; border-radius: 30px; background: #eef2f6; font-weight: 600; cursor: pointer;
        }
        .history-tabs button.active { background: #4a6fa5; color: white; }
        .history-filter { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 12px; }
        .history-filter-btn {
            background: #eef2f6; border: none; padding: 5px 12px; border-radius: 30px; font-size: 0.7rem; cursor: pointer;
        }
        .history-filter-btn.active { background: #4a6fa5; color: white; }
        .clear-history-btn { background: #fee2e2; color: #b91c1c; border: none; padding: 5px 12px; border-radius: 30px; margin-right: auto; cursor: pointer; }
        .table-wrapper {
            overflow-x: auto;
            max-height: 300px;
            border-radius: 16px;
        }
        .history-table, .sales-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
            min-width: 600px;
        }
        .history-table th, .sales-table th { background: #f1f5f9; padding: 8px; }
        .history-table td, .sales-table td { padding: 8px; border-bottom: 1px solid #edf2f7; }
        .loading, .empty-state { text-align: center; color: #94a3b8; padding: 30px; }
    </style>
</head>
<body>
<div id="app">
    <div class="connection-status" id="connectionStatus" style="display: none;"></div>

    <!-- Ø§Ù„Ø±Ø£Ø³ -->
    <div class="app-header">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Ø¨Ø­Ø«...">
        </div>
        <button class="header-btn" id="settingsBtn"><i class="fas fa-sliders-h"></i></button>
        <button class="header-btn" id="historyBtn"><i class="fas fa-history"></i></button>
        <button class="header-btn" id="toggleDataBtn"><i class="fas fa-eye-slash"></i></button>
        <button class="header-btn primary" id="addItemBtn"><i class="fas fa-plus"></i></button>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
    <div class="items-container" id="itemsList">
        <div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
    </div>

    <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ -->
    <div class="stats-footer" id="footerStats">
        <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ø±ÙŠØ¹ -->
        <div class="stats-section">
            <div class="stats-title">ğŸ“Š Ù…Ù„Ø®Øµ</div>
            <div class="stats-grid">
                <div class="stat-item"><span class="stat-label">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span><span class="stat-value" id="totalProducts">0</span></div>
                <div class="stat-item"><span class="stat-label">Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„</span><span class="stat-value" id="totalCapitalPrimary">$0</span></div>
                <div class="stat-item"><span class="stat-label">Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…Ø­ØªÙ…Ù„</span><span class="stat-value" id="totalProfitPrimary">$0</span></div>
                <div class="stat-item"><span class="stat-label">Ø§Ù„Ø£ØµÙ†Ø§Ù</span><span class="stat-value" id="totalCategories">0</span></div>
            </div>
        </div>
        <!-- Ù‚Ø³Ù… Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ -->
        <div class="stats-section">
            <div class="stats-title">ğŸ’° Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</div>
            <div class="stats-grid">
                <div class="stat-item"><span class="stat-label">Ø§Ù„ÙŠÙˆÙ…</span><span class="stat-value" id="profitDay">$0</span></div>
                <div class="stat-item"><span class="stat-label">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</span><span class="stat-value" id="profitWeek">$0</span></div>
                <div class="stat-item"><span class="stat-label">Ø§Ù„Ø´Ù‡Ø±</span><span class="stat-value" id="profitMonth">$0</span></div>
                <div class="stat-item"><span class="stat-label">Ø§Ù„Ø³Ù†Ø©</span><span class="stat-value" id="profitYear">$0</span></div>
            </div>
        </div>
    </div>

    <!-- Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª -->
    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ -->
    <div class="modal" id="itemModal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="modalTitle">Ø¥Ø¶Ø§ÙØ© Ù‚Ø·Ø¹Ø©</h2><button class="close-modal" id="closeModal">&times;</button></div>
            <form id="itemForm">
                <div class="form-group"><label>Ø§Ù„Ø§Ø³Ù… *</label><input type="text" id="itemName" required></div>
                <div class="form-group"><label id="purchasePriceLabel">Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ ($)</label><input type="number" id="purchasePrice" step="0.01" min="0" required><div class="currency-info" id="purchasePriceSecondary"></div></div>
                <div class="form-group"><label id="salePriceLabel">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ ($)</label><input type="number" id="salePrice" step="0.01" min="0" required><div class="currency-info" id="salePriceSecondary"></div></div>
                <div class="form-group"><label>Ø§Ù„ÙƒÙ…ÙŠØ©</label><input type="number" id="quantity" min="0" required></div>
                <div class="form-actions"><button type="button" class="cancel-btn" id="cancelBtn">Ø¥Ù„ØºØ§Ø¡</button><button type="submit" class="save-btn">Ø­ÙØ¸</button></div>
            </form>
        </div>
    </div>
    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ¹ -->
    <div class="modal" id="sellModal">
        <div class="modal-content">
            <div class="modal-header"><h2>Ø¨ÙŠØ¹</h2><button class="close-modal" id="closeSellModal">&times;</button></div>
            <form id="sellForm">
                <div class="form-group"><label>Ø§Ù„Ù…Ù†ØªØ¬: <span id="sellProductName"></span></label></div>
                <div class="form-group"><label>Ø§Ù„ÙƒÙ…ÙŠØ©</label><input type="number" id="sellQuantity" min="1" required></div>
                <div class="form-group"><label id="sellPriceLabel">Ø§Ù„Ø³Ø¹Ø± ($)</label><input type="number" id="sellPrice" step="0.01" required><div class="currency-info" id="sellPriceSecondaryInfo"></div></div>
                <div class="form-actions"><button type="button" class="cancel-btn" id="cancelSellBtn">Ø¥Ù„ØºØ§Ø¡</button><button type="submit" class="save-btn">ØªØ£ÙƒÙŠØ¯</button></div>
            </form>
        </div>
    </div>
    <!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ¹ -->
    <div class="modal" id="editSaleModal">
        <div class="modal-content">
            <div class="modal-header"><h2>ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ¹</h2><button class="close-modal" id="closeEditSaleModal">&times;</button></div>
            <form id="editSaleForm">
                <input type="hidden" id="editSaleId">
                <input type="hidden" id="editOriginalItemId">
                <input type="hidden" id="editOriginalQuantity">
                <input type="hidden" id="editSaleCurrency">
                <div class="form-group"><label>Ø§Ù„Ù…Ù†ØªØ¬: <span id="editProductName"></span></label></div>
                <div class="form-group"><label>Ø§Ù„ÙƒÙ…ÙŠØ©</label><input type="number" id="editQuantity" min="1" required></div>
                <div class="form-group"><label id="editPriceLabel">Ø§Ù„Ø³Ø¹Ø±</label><input type="number" id="editPrice" step="0.01" required><div class="currency-info" id="editPriceSecondaryInfo"></div></div>
                <div class="form-actions"><button type="button" class="cancel-btn" id="cancelEditSaleBtn">Ø¥Ù„ØºØ§Ø¡</button><button type="submit" class="save-btn">Ø­ÙØ¸</button></div>
            </form>
        </div>
    </div>
    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø³Ø¬Ù„ -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header"><h2>Ø§Ù„Ø³Ø¬Ù„</h2><button class="close-modal" id="closeHistoryModal">&times;</button></div>
            <div class="history-tabs"><button id="showActivityLogBtn" class="active">Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</button><button id="showSalesLogBtn">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</button></div>
            <div id="activityLogSection">
                <div class="history-filter">
                    <button class="history-filter-btn active" data-action="all">Ø§Ù„ÙƒÙ„</button>
                    <button class="history-filter-btn" data-action="add">Ø¥Ø¶Ø§ÙØ©</button>
                    <button class="history-filter-btn" data-action="update">ØªØ¹Ø¯ÙŠÙ„</button>
                    <button class="history-filter-btn" data-action="delete">Ø­Ø°Ù</button>
                    <button class="clear-history-btn" id="clearHistoryBtn"><i class="fas fa-trash-alt"></i> Ù…Ø³Ø­</button>
                </div>
                <div class="table-wrapper">
                    <table class="history-table">
                        <thead><tr><th>#</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th></tr></thead>
                        <tbody id="historyTableBody"></tbody>
                    </table>
                </div>
            </div>
            <div id="salesLogSection" style="display:none;">
                <div class="table-wrapper">
                    <table class="sales-table">
                        <thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„Ø±Ø¨Ø­</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                        <tbody id="salesLogBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header"><h2>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2><button class="close-modal" id="closeSettingsModal">&times;</button></div>
            <form id="settingsForm">
                <div class="form-group"><label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©</label><input type="text" id="secondaryCurrencyName" value="Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ"></div>
                <div class="form-group"><label>Ø§Ù„Ø±Ù…Ø²</label><input type="text" id="secondaryCurrencySymbol" value="ï·¼"></div>
                <div class="form-group"><label>Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù (1$ =)</label><input type="number" id="exchangeRate" step="0.01" value="3.75"></div>
                <div class="form-group"><label>Ø¹Ù…Ù„Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</label><div class="radio-group"><label><input type="radio" name="defaultInputCurrency" value="primary" checked> Ø¯ÙˆÙ„Ø§Ø±</label><label><input type="radio" name="defaultInputCurrency" value="secondary"> Ø«Ø§Ù†ÙˆÙŠØ©</label></div></div>
                <div class="form-group"><label>Ø¹Ù…Ù„Ø© Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</label><div class="radio-group"><label><input type="radio" name="defaultSellCurrency" value="primary" checked> Ø¯ÙˆÙ„Ø§Ø±</label><label><input type="radio" name="defaultSellCurrency" value="secondary"> Ø«Ø§Ù†ÙˆÙŠØ©</label></div></div>
                <div class="form-actions"><button type="button" class="cancel-btn" id="cancelSettingsBtn">Ø¥Ù„ØºØ§Ø¡</button><button type="submit" class="save-btn">Ø­ÙØ¸</button></div>
            </form>
        </div>
    </div>
</div>

<script>
    // -------------------- ØªÙƒÙˆÙŠÙ† Firebase --------------------
    const firebaseConfig = {
        apiKey: "AIzaSyBeJ0sbdCqz60a-yqzuZSt6QstDhR3TRtM",
        authDomain: "profit-zone-e03c6.firebaseapp.com",
        databaseURL: "https://profit-zone-e03c6-default-rtdb.firebaseio.com",
        projectId: "profit-zone-e03c6",
        storageBucket: "profit-zone-e03c6.firebasestorage.app",
        messagingSenderId: "306955059136",
        appId: "1:306955059136:web:a450be9721f4a2db0d1225"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // -------------------- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© --------------------
    let items = [];
    let sales = [];
    let activityLog = [];
    let currentItemId = null;
    let isEditing = false;
    let dataVisible = false;
    let currentFilter = 'all';
    let deleteConfirmId = null;

    let currencySettings = {
        secondaryCurrencyName: "Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ",
        secondaryCurrencySymbol: "ï·¼",
        exchangeRate: 3.75,
        defaultInputCurrency: "primary",
        defaultSellCurrency: "primary"
    };

    // Ø¹Ù†Ø§ØµØ± DOM
    const connectionStatus = document.getElementById('connectionStatus');
    const itemsList = document.getElementById('itemsList');
    const searchInput = document.getElementById('searchInput');
    const addItemBtn = document.getElementById('addItemBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const historyBtn = document.getElementById('historyBtn');
    const toggleDataBtn = document.getElementById('toggleDataBtn');
    const footerStats = document.getElementById('footerStats');
    const totalCategories = document.getElementById('totalCategories');
    const totalProducts = document.getElementById('totalProducts');
    const totalCapitalPrimary = document.getElementById('totalCapitalPrimary');
    const totalProfitPrimary = document.getElementById('totalProfitPrimary');
    const profitDay = document.getElementById('profitDay');
    const profitWeek = document.getElementById('profitWeek');
    const profitMonth = document.getElementById('profitMonth');
    const profitYear = document.getElementById('profitYear');

    // Ù…ÙˆØ¯Ø§Ù„Ø§Øª
    const itemModal = document.getElementById('itemModal');
    const sellModal = document.getElementById('sellModal');
    const editSaleModal = document.getElementById('editSaleModal');
    const historyModal = document.getElementById('historyModal');
    const settingsModal = document.getElementById('settingsModal');
    const closeModal = document.getElementById('closeModal');
    const closeSellModal = document.getElementById('closeSellModal');
    const closeEditSaleModal = document.getElementById('closeEditSaleModal');
    const closeHistoryModal = document.getElementById('closeHistoryModal');
    const closeSettingsModal = document.getElementById('closeSettingsModal');
    const cancelBtn = document.getElementById('cancelBtn');
    const cancelSellBtn = document.getElementById('cancelSellBtn');
    const cancelEditSaleBtn = document.getElementById('cancelEditSaleBtn');
    const cancelSettingsBtn = document.getElementById('cancelSettingsBtn');

    // Ù†Ù…Ø§Ø°Ø¬
    const itemForm = document.getElementById('itemForm');
    const sellForm = document.getElementById('sellForm');
    const editSaleForm = document.getElementById('editSaleForm');
    const settingsForm = document.getElementById('settingsForm');

    // Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
    const modalTitle = document.getElementById('modalTitle');
    const itemName = document.getElementById('itemName');
    const purchasePrice = document.getElementById('purchasePrice');
    const salePrice = document.getElementById('salePrice');
    const quantity = document.getElementById('quantity');
    const purchasePriceLabel = document.getElementById('purchasePriceLabel');
    const salePriceLabel = document.getElementById('salePriceLabel');
    const purchasePriceSecondary = document.getElementById('purchasePriceSecondary');
    const salePriceSecondary = document.getElementById('salePriceSecondary');

    // Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¨ÙŠØ¹
    const sellProductName = document.getElementById('sellProductName');
    const sellQuantity = document.getElementById('sellQuantity');
    const sellPrice = document.getElementById('sellPrice');
    const sellPriceLabel = document.getElementById('sellPriceLabel');
    const sellPriceSecondaryInfo = document.getElementById('sellPriceSecondaryInfo');

    // Ø­Ù‚ÙˆÙ„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ¹
    const editSaleId = document.getElementById('editSaleId');
    const editOriginalItemId = document.getElementById('editOriginalItemId');
    const editOriginalQuantity = document.getElementById('editOriginalQuantity');
    const editSaleCurrency = document.getElementById('editSaleCurrency');
    const editProductName = document.getElementById('editProductName');
    const editQuantity = document.getElementById('editQuantity');
    const editPrice = document.getElementById('editPrice');
    const editPriceLabel = document.getElementById('editPriceLabel');
    const editPriceSecondaryInfo = document.getElementById('editPriceSecondaryInfo');

    // Ø§Ù„Ø³Ø¬Ù„
    const historyTableBody = document.getElementById('historyTableBody');
    const salesLogBody = document.getElementById('salesLogBody');
    const showActivityLogBtn = document.getElementById('showActivityLogBtn');
    const showSalesLogBtn = document.getElementById('showSalesLogBtn');
    const activityLogSection = document.getElementById('activityLogSection');
    const salesLogSection = document.getElementById('salesLogSection');
    const clearHistoryBtn = document.getElementById('clearHistoryBtn');
    const historyFilter = document.querySelector('.history-filter');

    // -------------------- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© --------------------
    function updateConnectionStatus(status, message) {
        connectionStatus.style.display = 'flex';
        connectionStatus.className = 'connection-status ' + status;
        connectionStatus.innerHTML = `<i class="fas ${status==='online-status'?'fa-wifi':status==='offline-status'?'fa-wifi-slash':'fa-sync-alt fa-spin'}"></i><span>${message || ''}</span>`;
        if (status === 'online-status') setTimeout(() => connectionStatus.style.display = 'none', 2500);
    }

    function formatPrimary(amount) { return amount.toFixed(2); }
    function formatSecondary(amount) { return Number.isInteger(amount) ? amount : amount.toFixed(2).replace(/\.0+$/, ''); }
    function convertToSecondary(amount) { return amount * currencySettings.exchangeRate; }
    function convertToPrimary(sec) { return sec / currencySettings.exchangeRate; }
    function calculateProfitPercent(purchase, sale) {
        if (purchase === 0) return sale > 0 ? 100 : 0;
        return ((sale - purchase) / purchase * 100).toFixed(2);
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    function updateInventoryStats() {
        let totalCapital = 0, totalProfit = 0, totalQty = 0;
        items.forEach(i => {
            totalCapital += i.purchasePrice * i.quantity;
            totalProfit += (i.salePrice - i.purchasePrice) * i.quantity;
            totalQty += i.quantity;
        });
        totalCategories.textContent = items.length;
        totalProducts.textContent = totalQty;
        totalCapitalPrimary.textContent = `$${formatPrimary(totalCapital)}`;
        totalProfitPrimary.textContent = `$${formatPrimary(totalProfit)}`;
    }
    function updateSalesProfitStats() {
        const now = Date.now(), d = 86400000, w = 7*d, mo = 30*d, y = 365*d;
        let day = 0, week = 0, month = 0, year = 0;
        sales.forEach(s => {
            if (now - s.timestamp <= d) day += s.profit;
            if (now - s.timestamp <= w) week += s.profit;
            if (now - s.timestamp <= mo) month += s.profit;
            if (now - s.timestamp <= y) year += s.profit;
        });
        profitDay.textContent = `$${formatPrimary(day)}`;
        profitWeek.textContent = `$${formatPrimary(week)}`;
        profitMonth.textContent = `$${formatPrimary(month)}`;
        profitYear.textContent = `$${formatPrimary(year)}`;
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù‚Ø·Ø¹Ø©
    function updateSecondaryPrices() {
        const p = parseFloat(purchasePrice.value) || 0;
        const s = parseFloat(salePrice.value) || 0;
        if (currencySettings.defaultInputCurrency === 'secondary') {
            const pPrimary = convertToPrimary(p).toFixed(2);
            const sPrimary = convertToPrimary(s).toFixed(2);
            purchasePriceSecondary.innerText = `${Math.round(p)} ${currencySettings.secondaryCurrencySymbol} (â‰ˆ $${pPrimary})`;
            salePriceSecondary.innerText = `${Math.round(s)} ${currencySettings.secondaryCurrencySymbol} (â‰ˆ $${sPrimary})`;
        } else {
            purchasePriceSecondary.innerText = `${formatSecondary(convertToSecondary(p))} ${currencySettings.secondaryCurrencySymbol}`;
            salePriceSecondary.innerText = `${formatSecondary(convertToSecondary(s))} ${currencySettings.secondaryCurrencySymbol}`;
        }
    }
    function updatePriceLabels() {
        if (currencySettings.defaultInputCurrency === 'secondary') {
            purchasePriceLabel.innerText = `Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ (${currencySettings.secondaryCurrencySymbol})`;
            salePriceLabel.innerText = `Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ (${currencySettings.secondaryCurrencySymbol})`;
        } else {
            purchasePriceLabel.innerText = 'Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ ($)';
            salePriceLabel.innerText = 'Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ ($)';
        }
    }

    // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    function toggleDataVisibility() {
        dataVisible = !dataVisible;
        toggleDataBtn.innerHTML = dataVisible ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
        toggleDataBtn.classList.toggle('active', dataVisible);
        if (dataVisible) {
            footerStats.classList.add('visible');
        } else {
            footerStats.classList.remove('visible');
        }
        document.querySelectorAll('.purchase-price .primary-price, .purchase-price .secondary-price, .profit-badge').forEach(el => {
            el.classList.toggle('blur-price', !dataVisible);
        });
    }

    // -------------------- Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙƒØ¨Ø·Ø§Ù‚Ø§Øª --------------------
    function displayItems(filtered = items) {
        const sorted = [...filtered].sort((a,b) => a.name.localeCompare(b.name, 'ar'));
        if (sorted.length === 0) {
            itemsList.innerHTML = `<div class="empty-state"><i class="fas fa-box-open fa-3x"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</p><p>Ø£Ø¶Ù Ù…Ù†ØªØ¬Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹</p></div>`;
            updateInventoryStats(); return;
        }
        let html = '';
        sorted.forEach(item => {
            const profit = calculateProfitPercent(item.purchasePrice, item.salePrice);
            const profitClass = profit >= 0 ? 'profit-positive' : 'profit-negative';
            const profitSign = profit >= 0 ? '+' : '';
            const purchaseSec = formatSecondary(convertToSecondary(item.purchasePrice));
            const saleSec = formatSecondary(convertToSecondary(item.salePrice));
            let cardClass = '';
            if (item.quantity === 0) cardClass = 'out-of-stock';
            else if (item.quantity <= 2) cardClass = 'low-stock';

            const isConfirming = deleteConfirmId === item.id;

            html += `<div class="product-card ${cardClass}" data-id="${item.id}">
                <div class="card-header">
                    <span class="product-name">${item.name}</span>
                    <span class="stock-badge"><i class="fas fa-cubes"></i> ${item.quantity}</span>
                </div>
                <div class="price-row">
                    <div class="price-col purchase-price">
                        <div class="price-label">Ø´Ø±Ø§Ø¡</div>
                        <div class="primary-price ${dataVisible ? '' : 'blur-price'}">$${formatPrimary(item.purchasePrice)}</div>
                        <div class="secondary-price ${dataVisible ? '' : 'blur-price'}">${purchaseSec} ${currencySettings.secondaryCurrencySymbol}</div>
                    </div>
                    <div class="price-col sale-price">
                        <div class="price-label">Ø¨ÙŠØ¹</div>
                        <div class="primary-price">$${formatPrimary(item.salePrice)}</div>
                        <div class="secondary-price">${saleSec} ${currencySettings.secondaryCurrencySymbol}</div>
                    </div>
                </div>
                <div class="profit-section" style="display: flex; justify-content: space-between; align-items: center; margin: 6px 0;">
                    <span class="profit-badge ${profitClass} ${dataVisible ? '' : 'blur-price'}">${profitSign}${profit}%</span>
                </div>
                <div class="action-buttons">
                    ${!isConfirming ? 
                        `<button class="action-btn sell" data-id="${item.id}" ${item.quantity===0?'disabled':''}><i class="fas fa-shopping-cart"></i> Ø¨ÙŠØ¹</button>
                         <button class="action-btn edit" data-id="${item.id}"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„</button>
                         <button class="action-btn delete" data-id="${item.id}"><i class="fas fa-trash-alt"></i> Ø­Ø°Ù</button>`
                        :
                        `<button class="action-btn confirm-delete" data-id="${item.id}"><i class="fas fa-check"></i> ØªØ£ÙƒÙŠØ¯</button>
                         <button class="action-btn cancel-delete" data-id="${item.id}"><i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡</button>`
                    }
                </div>
            </div>`;
        });
        itemsList.innerHTML = html;
        updateInventoryStats();

        document.querySelectorAll('.sell').forEach(b => b.addEventListener('click', e => openSellModal(e.currentTarget.dataset.id)));
        document.querySelectorAll('.edit').forEach(b => b.addEventListener('click', e => editItem(e.currentTarget.dataset.id)));
        document.querySelectorAll('.delete').forEach(b => b.addEventListener('click', e => {
            deleteConfirmId = e.currentTarget.dataset.id;
            displayItems(searchInput.value ? items.filter(i => i.name.toLowerCase().includes(searchInput.value.toLowerCase())) : items);
        }));
        document.querySelectorAll('.confirm-delete').forEach(b => b.addEventListener('click', e => performDelete(e.currentTarget.dataset.id)));
        document.querySelectorAll('.cancel-delete').forEach(b => b.addEventListener('click', e => {
            deleteConfirmId = null;
            displayItems(searchInput.value ? items.filter(i => i.name.toLowerCase().includes(searchInput.value.toLowerCase())) : items);
        }));
    }

    // -------------------- Ø¹Ù…Ù„ÙŠØ§Øª Firebase Ùˆ localStorage --------------------
    function saveAllToLocalStorage() {
        try {
            localStorage.setItem('items', JSON.stringify(items));
            localStorage.setItem('sales', JSON.stringify(sales));
            localStorage.setItem('activityLog', JSON.stringify(activityLog));
            localStorage.setItem('currencySettings', JSON.stringify(currencySettings));
        } catch (e) { console.warn(e); }
    }

    function loadAllFromLocalStorage() {
        try {
            if (localStorage.getItem('items')) items = JSON.parse(localStorage.getItem('items'));
            if (localStorage.getItem('sales')) sales = JSON.parse(localStorage.getItem('sales'));
            if (localStorage.getItem('activityLog')) activityLog = JSON.parse(localStorage.getItem('activityLog'));
            if (localStorage.getItem('currencySettings')) currencySettings = JSON.parse(localStorage.getItem('currencySettings'));
            displayItems();
            updateSalesProfitStats();
        } catch (e) { console.warn(e); }
    }

    async function fetchItems() {
        try {
            const snap = await database.ref('items').once('value');
            items = snap.val() ? Object.keys(snap.val()).map(k => ({ id: k, ...snap.val()[k] })) : [];
            saveAllToLocalStorage();
            displayItems();
        } catch (e) {
            console.error(e);
            loadAllFromLocalStorage();
            updateConnectionStatus('offline-status', 'Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©');
        }
    }

    async function fetchSales() {
        try {
            const snap = await database.ref('sales').once('value');
            sales = snap.val() ? Object.keys(snap.val()).map(k => ({ saleId: k, ...snap.val()[k] })).sort((a,b)=>b.timestamp-a.timestamp) : [];
            saveAllToLocalStorage();
            updateSalesProfitStats();
        } catch (e) { console.warn(e); }
    }

    async function fetchActivityLog() {
        try {
            const snap = await database.ref('activityLog').once('value');
            activityLog = snap.val() ? Object.values(snap.val()).sort((a,b)=>b.timestamp-a.timestamp) : [];
            saveAllToLocalStorage();
        } catch (e) { console.warn(e); }
    }

    async function fetchCurrencySettings() {
        try {
            const snap = await database.ref('currencySettings').once('value');
            if (snap.val()) currencySettings = { ...currencySettings, ...snap.val() };
            saveAllToLocalStorage();
            // ØªØ­Ø¯ÙŠØ« Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©
            document.getElementById('secondaryCurrencyName').value = currencySettings.secondaryCurrencyName;
            document.getElementById('secondaryCurrencySymbol').value = currencySettings.secondaryCurrencySymbol;
            document.getElementById('exchangeRate').value = currencySettings.exchangeRate;
            document.querySelector(`input[name="defaultInputCurrency"][value="${currencySettings.defaultInputCurrency}"]`).checked = true;
            document.querySelector(`input[name="defaultSellCurrency"][value="${currencySettings.defaultSellCurrency}"]`).checked = true;
            updatePriceLabels();
            updateSecondaryPrices();
        } catch (e) { console.warn(e); }
    }

    async function saveItemToFirebase(item) {
        const { id, ...data } = item;
        await database.ref('items/' + id).set(data);
        saveAllToLocalStorage();
    }

    async function deleteItemFromFirebase(id) {
        await database.ref('items/' + id).remove();
        saveAllToLocalStorage();
    }

    function generateActivityId() { return 'act_' + Date.now() + '_' + Math.random().toString(36).substr(2,9); }
    function formatDateTime(date) { return date.toLocaleString('ar-EG'); }

    async function addToActivityLog(actionType, details, itemData = null) {
        const timestamp = Date.now();
        const activityId = generateActivityId();
        const activity = { activityId, actionType, details, timestamp, dateTime: formatDateTime(new Date(timestamp)), itemData };
        activityLog.unshift(activity);
        try {
            await database.ref('activityLog/' + activityId).set(activity);
            saveAllToLocalStorage();
        } catch (e) { console.warn(e); }
        if (historyModal.style.display === 'flex' && activityLogSection.style.display !== 'none') displayActivityLog();
    }

    // -------------------- Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª --------------------
    function addItem() {
        currentItemId = null; isEditing = false;
        itemForm.reset();
        modalTitle.innerText = 'Ø¥Ø¶Ø§ÙØ© Ù‚Ø·Ø¹Ø©';
        updatePriceLabels();
        updateSecondaryPrices();
        itemModal.style.display = 'flex';
    }

    function editItem(itemId) {
        const item = items.find(i => i.id === itemId);
        if (!item) return;
        currentItemId = itemId; isEditing = true;
        itemName.value = item.name;
        if (currencySettings.defaultInputCurrency === 'secondary') {
            purchasePrice.value = Math.round(convertToSecondary(item.purchasePrice));
            salePrice.value = Math.round(convertToSecondary(item.salePrice));
        } else {
            purchasePrice.value = item.purchasePrice;
            salePrice.value = item.salePrice;
        }
        quantity.value = item.quantity;
        modalTitle.innerText = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø·Ø¹Ø©';
        updatePriceLabels();
        updateSecondaryPrices();
        itemModal.style.display = 'flex';
    }

    async function performDelete(itemId) {
        const item = items.find(i => i.id === itemId);
        if (!item) return;
        try {
            await deleteItemFromFirebase(itemId);
            items = items.filter(i => i.id !== itemId);
            await addToActivityLog('delete', `Ø­Ø°Ù "${item.name}"`, item);
            deleteConfirmId = null;
            displayItems();
            updateConnectionStatus('online-status', 'ØªÙ… Ø§Ù„Ø­Ø°Ù');
        } catch (e) {
            alert('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù');
            console.error(e);
        }
    }

    itemForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = itemName.value.trim();
        let purchase, sale;
        if (currencySettings.defaultInputCurrency === 'secondary') {
            const pSec = parseFloat(purchasePrice.value);
            const sSec = parseFloat(salePrice.value);
            if (isNaN(pSec) || pSec < 0 || isNaN(sSec) || sSec < 0) return alert('Ù‚ÙŠÙ… ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
            purchase = convertToPrimary(pSec);
            sale = convertToPrimary(sSec);
        } else {
            purchase = parseFloat(purchasePrice.value);
            sale = parseFloat(salePrice.value);
        }
        const qty = parseInt(quantity.value);
        if (!name || isNaN(purchase) || isNaN(sale) || isNaN(qty) || purchase < 0 || sale < 0 || qty < 0)
            return alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');

        try {
            if (isEditing) {
                const item = items.find(i => i.id === currentItemId);
                if (!item) return;
                item.name = name; item.purchasePrice = purchase; item.salePrice = sale; item.quantity = qty; item.updatedAt = Date.now();
                await saveItemToFirebase(item);
                await addToActivityLog('update', `ØªØ¹Ø¯ÙŠÙ„ "${name}"`, item);
            } else {
                const newId = 'item_' + Date.now() + '_' + Math.random().toString(36).substr(2,9);
                const newItem = { id: newId, name, purchasePrice: purchase, salePrice: sale, quantity: qty, createdAt: Date.now(), updatedAt: Date.now() };
                await saveItemToFirebase(newItem);
                items.push(newItem);
                await addToActivityLog('add', `Ø¥Ø¶Ø§ÙØ© "${name}"`, newItem);
            }
            displayItems();
            itemModal.style.display = 'none';
            updateConnectionStatus('online-status', isEditing ? 'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«' : 'ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
        } catch (e) {
            alert('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸');
            console.error(e);
        }
    });

    // -------------------- Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¨ÙŠØ¹ --------------------
    function openSellModal(itemId) {
        const item = items.find(i => i.id === itemId);
        if (!item) return;
        sellProductName.innerText = item.name;
        sellQuantity.value = 1;
        sellQuantity.max = item.quantity;
        if (currencySettings.defaultSellCurrency === 'primary') {
            sellPriceLabel.innerText = 'Ø§Ù„Ø³Ø¹Ø± ($)';
            sellPrice.value = item.salePrice;
            updateSecondarySellPrice();
        } else {
            sellPriceLabel.innerText = `Ø§Ù„Ø³Ø¹Ø± (${currencySettings.secondaryCurrencySymbol})`;
            sellPrice.value = convertToSecondary(item.salePrice);
            updatePrimarySellPrice();
        }
        sellForm.dataset.itemId = itemId;
        sellModal.style.display = 'flex';
    }

    function updateSecondarySellPrice() {
        const primary = parseFloat(sellPrice.value) || 0;
        sellPriceSecondaryInfo.innerText = `ØªØ¹Ø§Ø¯Ù„ ${formatSecondary(convertToSecondary(primary))} ${currencySettings.secondaryCurrencySymbol}`;
    }
    function updatePrimarySellPrice() {
        const sec = parseFloat(sellPrice.value) || 0;
        sellPriceSecondaryInfo.innerText = `ØªØ¹Ø§Ø¯Ù„ $${formatPrimary(convertToPrimary(sec))}`;
    }

    sellForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const itemId = sellForm.dataset.itemId;
        const item = items.find(i => i.id === itemId);
        if (!item) return;
        const qty = parseInt(sellQuantity.value);
        if (qty <= 0 || qty > item.quantity) return alert('ÙƒÙ…ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­Ø©');
        let pricePrimary, usedCurrency;
        if (currencySettings.defaultSellCurrency === 'primary') {
            pricePrimary = parseFloat(sellPrice.value);
            usedCurrency = 'primary';
        } else {
            const sec = parseFloat(sellPrice.value);
            if (isNaN(sec) || sec < 0) return alert('Ø³Ø¹Ø± ØºÙŠØ± ØµØ§Ù„Ø­');
            pricePrimary = convertToPrimary(sec);
            usedCurrency = 'secondary';
        }
        const profit = (pricePrimary - item.purchasePrice) * qty;
        const sale = {
            itemId: item.id, itemName: item.name, quantity: qty, unitPrice: pricePrimary,
            totalAmount: pricePrimary * qty, profit, purchasePriceAtTime: item.purchasePrice,
            timestamp: Date.now(), saleCurrency: usedCurrency
        };
        try {
            item.quantity -= qty;
            await database.ref('items/' + item.id).set({
                name: item.name, purchasePrice: item.purchasePrice, salePrice: item.salePrice, quantity: item.quantity, updatedAt: Date.now()
            });
            const newSaleRef = await database.ref('sales').push(sale);
            sale.saleId = newSaleRef.key;
            items = items.map(i => i.id === item.id ? item : i);
            sales.unshift(sale);
            displayItems();
            updateSalesProfitStats();
            saveAllToLocalStorage();
            sellModal.style.display = 'none';
            updateConnectionStatus('online-status', 'ØªÙ… Ø§Ù„Ø¨ÙŠØ¹');
        } catch (e) { alert('ÙØ´Ù„ Ø§Ù„Ø¨ÙŠØ¹'); console.error(e); }
    });

    // -------------------- ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ¹ (Ù…ÙØ¹Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„) --------------------
    window.editSale = (saleId) => {
        const sale = sales.find(s => s.saleId === saleId);
        if (!sale) return;
        const product = items.find(i => i.id === sale.itemId);
        if (!product) return alert('Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
        editSaleId.value = sale.saleId;
        editOriginalItemId.value = sale.itemId;
        editOriginalQuantity.value = sale.quantity;
        editSaleCurrency.value = sale.saleCurrency || 'primary';
        editProductName.innerText = sale.itemName;
        editQuantity.value = sale.quantity;
        editQuantity.max = product.quantity + sale.quantity; // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„Ù…ØªØ§Ø­ Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ©
        if (editSaleCurrency.value === 'primary') {
            editPriceLabel.innerText = 'Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© ($)';
            editPrice.value = sale.unitPrice;
            updateSecondaryEditPrice();
        } else {
            editPriceLabel.innerText = `Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© (${currencySettings.secondaryCurrencySymbol})`;
            editPrice.value = formatSecondary(convertToSecondary(sale.unitPrice));
            updatePrimaryEditPrice();
        }
        editPrice.oninput = handleEditPriceChange;
        editSaleModal.style.display = 'flex';
    };

    function handleEditPriceChange() {
        if (editSaleCurrency.value === 'primary') updateSecondaryEditPrice();
        else updatePrimaryEditPrice();
    }
    function updateSecondaryEditPrice() {
        const primary = parseFloat(editPrice.value) || 0;
        editPriceSecondaryInfo.innerText = `ØªØ¹Ø§Ø¯Ù„ ${formatSecondary(convertToSecondary(primary))} ${currencySettings.secondaryCurrencySymbol}`;
    }
    function updatePrimaryEditPrice() {
        const sec = parseFloat(editPrice.value) || 0;
        editPriceSecondaryInfo.innerText = `ØªØ¹Ø§Ø¯Ù„ $${formatPrimary(convertToPrimary(sec))}`;
    }

    editSaleForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const saleId = editSaleId.value;
        const itemId = editOriginalItemId.value;
        const oldQty = parseInt(editOriginalQuantity.value);
        const newQty = parseInt(editQuantity.value);
        let newPriceInPrimary;
        if (editSaleCurrency.value === 'primary') newPriceInPrimary = parseFloat(editPrice.value);
        else newPriceInPrimary = convertToPrimary(parseFloat(editPrice.value));
        if (newQty <= 0 || newPriceInPrimary < 0) return alert('Ù‚ÙŠÙ… ØºÙŠØ± ØµØ§Ù„Ø­Ø©');
        const sale = sales.find(s => s.saleId === saleId);
        const product = items.find(i => i.id === itemId);
        if (!sale || !product) return;
        const diff = newQty - oldQty;
        if (diff > 0 && product.quantity < diff) return alert('Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
        try {
            product.quantity -= diff;
            await database.ref('items/' + product.id).set({
                name: product.name, purchasePrice: product.purchasePrice, salePrice: product.salePrice, quantity: product.quantity, updatedAt: Date.now()
            });
            const newTotal = newQty * newPriceInPrimary;
            const newProfit = (newPriceInPrimary - product.purchasePrice) * newQty;
            const updated = { ...sale, quantity: newQty, unitPrice: newPriceInPrimary, totalAmount: newTotal, profit: newProfit };
            await database.ref('sales/' + saleId).set(updated);
            items = items.map(i => i.id === product.id ? product : i);
            Object.assign(sale, updated);
            displayItems();
            updateSalesProfitStats();
            saveAllToLocalStorage();
            if (historyModal.style.display === 'flex' && salesLogSection.style.display !== 'none') displaySalesLog();
            editSaleModal.style.display = 'none';
            updateConnectionStatus('online-status', 'ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
        } catch (e) { alert('ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'); console.error(e); }
    });

    // -------------------- Ø§Ù„Ø³Ø¬Ù„ ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª --------------------
    function displayActivityLog(filter = currentFilter) {
        let filtered = filter === 'all' ? activityLog : activityLog.filter(a => a.actionType === filter);
        if (!filtered.length) { historyTableBody.innerHTML = '<tr><td colspan="4" class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª</td></tr>'; return; }
        let html = '';
        filtered.forEach((act, idx) => {
            let typeTxt = { add:'Ø¥Ø¶Ø§ÙØ©', update:'ØªØ¹Ø¯ÙŠÙ„', delete:'Ø­Ø°Ù', quantity:'ØªØºÙŠÙŠØ± ÙƒÙ…ÙŠØ©', settings:'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª' }[act.actionType] || act.actionType;
            html += `<tr><td>${idx+1}</td><td>${act.dateTime || ''}</td><td>${typeTxt}</td><td>${act.details}</td></tr>`;
        });
        historyTableBody.innerHTML = html;
    }

    function displaySalesLog() {
        if (!sales.length) { salesLogBody.innerHTML = '<tr><td colspan="7" class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª</td></tr>'; return; }
        let html = '';
        sales.forEach(s => {
            html += `<tr>
                <td>${s.itemName}</td>
                <td>${s.quantity}</td>
                <td>$${formatPrimary(s.unitPrice)}</td>
                <td>$${formatPrimary(s.totalAmount)}</td>
                <td>$${formatPrimary(s.profit)}</td>
                <td>${new Date(s.timestamp).toLocaleString()}</td>
                <td>
                    <button class="action-btn edit" onclick="editSale('${s.saleId}')"><i class="fas fa-edit"></i></button>
                    <button class="action-btn delete" onclick="cancelSale('${s.saleId}')"><i class="fas fa-undo-alt"></i></button>
                </td>
            </tr>`;
        });
        salesLogBody.innerHTML = html;
    }

    window.cancelSale = async (saleId) => {
        if (!confirm('Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¨ÙŠØ¹ØŸ')) return;
        const sale = sales.find(s => s.saleId === saleId);
        if (!sale) return;
        const product = items.find(i => i.id === sale.itemId);
        if (!product) return alert('Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
        try {
            product.quantity += sale.quantity;
            await database.ref('items/' + product.id).set({ name: product.name, purchasePrice: product.purchasePrice, salePrice: product.salePrice, quantity: product.quantity, updatedAt: Date.now() });
            await database.ref('sales/' + saleId).remove();
            items = items.map(i => i.id === product.id ? product : i);
            sales = sales.filter(s => s.saleId !== saleId);
            displayItems(); updateSalesProfitStats(); saveAllToLocalStorage();
            if (historyModal.style.display === 'flex' && salesLogSection.style.display !== 'none') displaySalesLog();
            updateConnectionStatus('online-status', 'ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡');
        } catch (e) { alert('ÙØ´Ù„'); console.error(e); }
    };

    // -------------------- Ø£Ø­Ø¯Ø§Ø« --------------------
    addItemBtn.addEventListener('click', addItem);
    settingsBtn.addEventListener('click', () => settingsModal.style.display = 'flex');
    historyBtn.addEventListener('click', () => {
        historyModal.style.display = 'flex';
        if (activityLogSection.style.display !== 'none') displayActivityLog(); else displaySalesLog();
    });
    toggleDataBtn.addEventListener('click', toggleDataVisibility);

    closeModal.addEventListener('click', () => itemModal.style.display = 'none');
    closeSellModal.addEventListener('click', () => sellModal.style.display = 'none');
    closeEditSaleModal.addEventListener('click', () => editSaleModal.style.display = 'none');
    closeHistoryModal.addEventListener('click', () => historyModal.style.display = 'none');
    closeSettingsModal.addEventListener('click', () => settingsModal.style.display = 'none');
    cancelBtn.addEventListener('click', () => itemModal.style.display = 'none');
    cancelSellBtn.addEventListener('click', () => sellModal.style.display = 'none');
    cancelEditSaleBtn.addEventListener('click', () => editSaleModal.style.display = 'none');
    cancelSettingsBtn.addEventListener('click', () => settingsModal.style.display = 'none');

    purchasePrice.addEventListener('input', updateSecondaryPrices);
    salePrice.addEventListener('input', updateSecondaryPrices);
    sellPrice.addEventListener('input', function() {
        if (currencySettings.defaultSellCurrency === 'primary') updateSecondarySellPrice(); else updatePrimarySellPrice();
    });

    searchInput.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        displayItems(items.filter(i => i.name.toLowerCase().includes(term)));
    });

    showActivityLogBtn.addEventListener('click', () => {
        showActivityLogBtn.classList.add('active'); showSalesLogBtn.classList.remove('active');
        activityLogSection.style.display = 'block'; salesLogSection.style.display = 'none';
        displayActivityLog();
    });
    showSalesLogBtn.addEventListener('click', () => {
        showSalesLogBtn.classList.add('active'); showActivityLogBtn.classList.remove('active');
        activityLogSection.style.display = 'none'; salesLogSection.style.display = 'block';
        displaySalesLog();
    });

    historyFilter.addEventListener('click', (e) => {
        if (e.target.classList.contains('history-filter-btn')) {
            document.querySelectorAll('.history-filter-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            currentFilter = e.target.dataset.action;
            displayActivityLog(currentFilter);
        }
    });

    clearHistoryBtn.addEventListener('click', async () => {
        if (confirm('Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ')) {
            try { await database.ref('activityLog').remove(); activityLog = []; saveAllToLocalStorage(); displayActivityLog(); } catch (e) { alert('ÙØ´Ù„'); }
        }
    });

    settingsForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const newSettings = {
            secondaryCurrencyName: document.getElementById('secondaryCurrencyName').value.trim(),
            secondaryCurrencySymbol: document.getElementById('secondaryCurrencySymbol').value.trim(),
            exchangeRate: parseFloat(document.getElementById('exchangeRate').value),
            defaultInputCurrency: document.querySelector('input[name="defaultInputCurrency"]:checked').value,
            defaultSellCurrency: document.querySelector('input[name="defaultSellCurrency"]:checked').value
        };
        if (!newSettings.secondaryCurrencyName || !newSettings.secondaryCurrencySymbol || isNaN(newSettings.exchangeRate) || newSettings.exchangeRate <= 0)
            return alert('Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
        try {
            await database.ref('currencySettings').set(newSettings);
            currencySettings = newSettings;
            await addToActivityLog('settings', 'ØªØºÙŠÙŠØ± Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø©');
            updatePriceLabels(); updateSecondaryPrices(); displayItems();
            settingsModal.style.display = 'none';
            updateConnectionStatus('online-status', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
        } catch (e) { alert('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸'); }
    });

    window.addEventListener('click', (e) => {
        if (e.target === itemModal) itemModal.style.display = 'none';
        if (e.target === sellModal) sellModal.style.display = 'none';
        if (e.target === editSaleModal) editSaleModal.style.display = 'none';
        if (e.target === historyModal) historyModal.style.display = 'none';
        if (e.target === settingsModal) settingsModal.style.display = 'none';
    });

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    async function init() {
        updateConnectionStatus('syncing-status', 'Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...');
        await fetchCurrencySettings();
        await fetchItems();
        await fetchSales();
        await fetchActivityLog();
        updateConnectionStatus('online-status', 'ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„');
        dataVisible = false;
        toggleDataBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
        footerStats.classList.remove('visible');
    }
    init();
</script>
</body>
</html>
