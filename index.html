<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø­Ù„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… - Ù…Ø¹ Ø§Ù„ÙØ¦Ø§Øª ÙˆØ§Ù„Ù…ØªØ¬Ø±</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body {
            background: #f1f5f9;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #app {
            width: 100%;
            max-width: 450px;
            height: 100%;
            background: white;
            box-shadow: 0 0 25px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-radius: 24px 24px 0 0;
            position: relative;
        }
        .connection-status {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 2000;
            background: #1e2b3c;
            color: white;
            padding: 6px 14px;
            border-radius: 30px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .online-status { background: #27ae60; }
        .offline-status { background: #e74c3c; }
        .syncing-status { background: #3498db; }

        /* Ø§Ù„Ø±Ø£Ø³ */
        .app-header {
            background: white;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid #eef2f6;
        }
        .search-box {
            flex: 1;
            position: relative;
        }
        .search-box i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
        }
        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 1px solid #e2e8f0;
            border-radius: 40px;
            background: #f8fafc;
            font-size: 0.9rem;
        }
        .search-box input:focus {
            outline: none;
            border-color: #4a6fa5;
            background: white;
        }
        .header-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #f1f5f9;
            border: none;
            color: #2d3a4f;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.2s;
        }
        .header-btn.primary { background: #27ae60; color: white; }
        .header-btn.store-status-open { background: #27ae60; color: white; }
        .header-btn.store-status-closed { background: #94a3b8; color: white; }
        .header-btn:active { transform: scale(0.94); background: #e2e8f0; }

        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª */
        .items-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px 12px;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù†ØªØ¬ */
        .product-card {
            background: white;
            border-radius: 24px;
            padding: 16px 16px 16px 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.02);
            border: 1px solid #edf2f9;
            transition: 0.2s;
            position: relative;
            margin-right: 15px;
            margin-left: 15px;
        }
        .product-card.low-stock {
            border-right: 6px solid #f97316;
            background: #fffaf0;
        }
        .product-card.out-of-stock {
            border-right: 6px solid #ef4444;
            background: #fef2f2;
        }
        .product-index-outer {
            position: absolute;
            right: -15px;
            top: 50%;
            transform: translateY(-50%);
            width: 36px;
            height: 36px;
            background: #4a6fa5;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1rem;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            border: 2px solid white;
            z-index: 2;
        }
        .product-details-outer {
            position: absolute;
            left: -15px;
            top: 50%;
            transform: translateY(-50%);
            width: 36px;
            height: 36px;
            background: #3498db;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1rem;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            border: 2px solid white;
            z-index: 2;
            cursor: pointer;
            transition: 0.2s;
        }
        .product-details-outer:hover {
            background: #2980b9;
            transform: translateY(-50%) scale(1.1);
        }
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .product-title {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 2px;
        }
        .product-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: #1e2b3c;
        }
        .product-category {
            font-size: 0.7rem;
            color: #6f7d95;
            background: #eef2f6;
            padding: 2px 8px;
            border-radius: 20px;
            display: inline-block;
        }
        .product-meta {
            display: flex;
            gap: 8px;
            font-size: 0.75rem;
            background: #f0f4fa;
            padding: 4px 10px;
            border-radius: 30px;
        }
        .meta-item {
            display: flex;
            align-items: center;
            gap: 3px;
        }
        .profit-badge-small {
            background: transparent;
            font-weight: 600;
        }
        .profit-positive { color: #1e7b4c; }
        .profit-negative { color: #b53b3b; }

        .action-icons {
            display: flex;
            gap: 5px;
        }
        .icon-btn {
            background: none;
            border: none;
            font-size: 1.1rem;
            color: #4b6584;
            cursor: pointer;
            padding: 4px;
            transition: 0.2s;
        }
        .icon-btn.active { color: #4a6fa5; }
        .icon-btn:hover { color: #1e2b3c; }

        .price-row {
            display: flex;
            background: #f8fafd;
            border-radius: 20px;
            padding: 12px 0;
            margin: 8px 0;
            border: 1px solid #eef2f6;
        }
        .price-col {
            flex: 1;
            text-align: center;
            border-left: 1px dashed #d0d9e8;
        }
        .price-col:last-child { border-left: none; }
        .price-label {
            font-size: 0.7rem;
            color: #6f7d95;
            text-transform: uppercase;
        }
        .primary-price {
            font-weight: 800;
            font-size: 1.1rem;
        }
        .purchase-price .primary-price { color: #e55353; }
        .sale-price .primary-price { color: #2e9a5e; }
        .secondary-price {
            font-size: 0.7rem;
            color: #5f6c84;
        }
        .blur-price {
            filter: blur(5px);
            user-select: none;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .action-btn {
            flex: 1;
            padding: 12px 0;
            border: none;
            border-radius: 40px;
            font-weight: 600;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            background: #f0f4fc;
            color: #2d3a4f;
            cursor: pointer;
            transition: 0.2s;
        }
        .action-btn.sell { background: #27ae60; color: white; }
        .action-btn.sell:disabled { background: #cbd5e0; color: #94a3b8; }
        .action-btn.edit { background: #e3efff; color: #1e5f9e; }
        .action-btn.delete { background: #ffeae8; color: #c23321; }
        .action-btn.confirm-delete { background: #ef4444; color: white; }
        .action-btn.cancel-delete { background: #94a3b8; color: white; }

        /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 12px;
        }
        .modal-content {
            background: white;
            border-radius: 36px;
            width: 100%;
            max-width: 420px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 24px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h2 { font-size: 1.4rem; color: #1e2b3c; }
        .close-modal {
            background: none; border: none; font-size: 2rem; line-height: 1; cursor: pointer; color: #94a3b8;
        }
        /* ØªØ­Ø³ÙŠÙ† Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª */
        .form-group {
            margin-bottom: 18px;
            position: relative;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 0.9rem;
            color: #334155;
        }
        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø­Ù‚Ù„ Ù…Ø¹ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© */
        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            width: 100%;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 30px;
            transition: 0.2s;
        }
        .input-wrapper:focus-within {
            border-color: #4a6fa5;
            background: white;
            box-shadow: 0 0 0 3px rgba(74,111,165,0.1);
        }
        .input-wrapper i {
            position: absolute;
            right: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            font-size: 1rem;
            z-index: 1;
        }
        .input-wrapper input,
        .input-wrapper select,
        .input-wrapper textarea {
            width: 100%;
            padding: 14px 50px 14px 18px; /* Ø­Ø´ÙˆØ© Ù„Ù„ÙŠÙ…ÙŠÙ† Ù„ØªØ±Ùƒ Ù…ÙƒØ§Ù† Ù„Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© */
            border: none;
            background: transparent;
            font-size: 1rem;
            border-radius: 30px;
            outline: none;
        }
        .input-wrapper textarea {
            min-height: 90px;
            resize: vertical;
            padding-top: 18px;
            padding-bottom: 18px;
        }
        .input-wrapper select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left 18px center;
            background-size: 16px;
        }
        /* Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø®Ø§ØµØ© (Ù…Ø¹ Ø²Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„) */
        .input-wrapper.special {
            padding-left: 60px; /* Ù…ÙƒØ§Ù† Ù„Ù„Ø²Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± */
            padding-right: 50px; /* Ù…ÙƒØ§Ù† Ù„Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† */
        }
        .currency-switch {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: #eef2f6;
            border: none;
            border-radius: 30px;
            width: 44px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: #2d3a4f;
            cursor: pointer;
            transition: 0.2s;
            z-index: 2;
        }
        .currency-switch:hover { background: #e2e8f0; }
        .currency-info {
            font-size: 0.8rem;
            color: #4b6584;
            margin-top: 6px;
            padding-right: 16px;
        }
        .radio-group { display: flex; gap: 20px; flex-wrap: wrap; }
        .radio-group label { display: flex; align-items: center; gap: 5px; font-weight: normal; cursor: pointer; }
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }
        .save-btn, .cancel-btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 40px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
        }
        .save-btn { background: #27ae60; color: white; }
        .cancel-btn { background: #f1f5f9; color: #1e2b3c; }

        /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø³Ø¬Ù„ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
        .report-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }
        .report-tab {
            flex: 1 0 auto;
            padding: 10px 12px;
            border: none;
            border-radius: 40px;
            background: #eef2f6;
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
            transition: 0.2s;
            white-space: nowrap;
        }
        .report-tab.active {
            background: #4a6fa5;
            color: white;
        }
        .report-section {
            display: none;
        }
        .report-section.active {
            display: block;
        }
        .stats-cards {
            background: #f8fafd;
            border-radius: 24px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .stats-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: #2d3a4f;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .profit-period {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        .period-item {
            background: white;
            border-radius: 20px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
            border: 1px solid #e2e8f0;
        }
        .period-label {
            font-size: 0.7rem;
            color: #6f7d95;
        }
        .period-value {
            font-size: 1.2rem;
            font-weight: 800;
            color: #1e2b3c;
        }
        .summary-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
        }
        .summary-item {
            min-width: 80px;
        }
        .summary-label {
            font-size: 0.6rem;
            color: #6f7d95;
            text-transform: uppercase;
        }
        .summary-number {
            font-weight: 700;
            font-size: 1.2rem;
        }

        /* Ù‚Ø³Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ¦Ø§Øª */
        .categories-list {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 8px;
        }
        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f8fafd;
            border-radius: 40px;
            margin-bottom: 6px;
        }
        .category-name {
            font-weight: 600;
        }
        .delete-category {
            background: none;
            border: none;
            color: #ef4444;
            font-size: 1rem;
            cursor: pointer;
            padding: 4px 8px;
        }
        .add-category-form {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .add-category-form input {
            flex: 1;
            padding: 12px;
            border: 1px solid #dde2e9;
            border-radius: 40px;
        }
        .add-category-form button {
            background: #4a6fa5;
            color: white;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            font-size: 1.2rem;
            cursor: pointer;
        }

        /* Ù‚Ø³Ù… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØªØ¬Ø± */
        .social-links-list {
            margin-top: 15px;
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 8px;
        }
        .social-item {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
            background: #f8fafd;
            padding: 8px;
            border-radius: 40px;
        }
        .social-item input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #dde2e9;
            border-radius: 20px;
            font-size: 0.8rem;
        }
        .delete-social {
            background: none;
            border: none;
            color: #ef4444;
            font-size: 1rem;
            cursor: pointer;
            padding: 4px 8px;
        }
        .add-social-btn {
            background: #4a6fa5;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 10px;
        }

        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        .table-wrapper {
            overflow-x: auto;
            max-height: 250px;
            border-radius: 16px;
            border: 1px solid #edf2f7;
        }
        .history-table, .sales-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
            min-width: 500px;
        }
        .history-table th, .sales-table th {
            background: #f1f5f9;
            padding: 8px;
            position: sticky;
            top: 0;
        }
        .history-table td, .sales-table td {
            padding: 8px;
            border-bottom: 1px solid #edf2f7;
        }
        .date-group-header {
            background: #e6edf7;
            font-weight: 700;
            text-align: center;
            color: #1e2b3c;
            padding: 6px;
            border-top: 2px solid #b0c4de;
            border-bottom: 2px solid #b0c4de;
        }
        .loading, .empty-state { text-align: center; color: #94a3b8; padding: 30px; }

        /* Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ */
        .product-details-view {
            text-align: center;
        }
        .product-details-view img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 16px;
            margin-bottom: 15px;
            object-fit: contain;
            background: #f1f5f9;
        }
        .specs-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.85rem;
        }
        .specs-table th, .specs-table td {
            border: 1px solid #e2e8f0;
            padding: 8px;
            text-align: right;
        }
        .specs-table th {
            background: #f1f5f9;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
        .settings-section {
            margin-top: 25px;
            padding-top: 15px;
            border-top: 2px solid #eef2f6;
        }
        .settings-section:first-of-type {
            margin-top: 0;
            border-top: none;
        }
        .section-icon {
            color: #4a6fa5;
            margin-left: 5px;
        }
        /* ØªØ­Ø³ÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ± */
        .history-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }
        .history-filter-btn, .clear-history-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 30px;
            background: #eef2f6;
            font-weight: 600;
            font-size: 0.75rem;
            cursor: pointer;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .history-filter-btn.active {
            background: #4a6fa5;
            color: white;
        }
        .clear-history-btn {
            background: #ffeae8;
            color: #c23321;
        }
    </style>
</head>
<body>
<div id="app">
    <div class="connection-status" id="connectionStatus" style="display: none;"></div>

    <!-- Ø§Ù„Ø±Ø£Ø³ -->
    <div class="app-header">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Ø¨Ø­Ø«...">
        </div>
        <!-- Ø²Ø± Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØªØ¬Ø± -->
        <button class="header-btn" id="storeStatusBtn" title="Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØªØ¬Ø±">
            <i class="fas fa-store"></i>
        </button>
        <button class="header-btn" id="settingsBtn"><i class="fas fa-sliders-h"></i></button>
        <button class="header-btn" id="historyBtn"><i class="fas fa-history"></i></button>
        <button class="header-btn primary" id="addItemBtn"><i class="fas fa-plus"></i></button>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
    <div class="items-container" id="itemsList">
        <div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­ÙˆÙ„ Ø¹Ø±ÙŠØ¶Ø© ÙˆØ§Ø­ØªØ±Ø§ÙÙŠØ©) -->
    <div class="modal" id="itemModal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="modalTitle">Ø¥Ø¶Ø§ÙØ© Ù‚Ø·Ø¹Ø©</h2><button class="close-modal" id="closeModal">&times;</button></div>
            <form id="itemForm">
                <div class="form-group">
                    <label>Ø§Ù„Ø§Ø³Ù… *</label>
                    <div class="input-wrapper"><i class="fas fa-tag"></i><input type="text" id="itemName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" required></div>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ÙØ¦Ø©</label>
                    <div class="input-wrapper"><i class="fas fa-folder"></i><select id="itemCategory"><option value="">Ø¨Ø¯ÙˆÙ† ÙØ¦Ø©</option></select></div>
                </div>
                <div class="form-group">
                    <label>Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©</label>
                    <div class="input-wrapper"><i class="fas fa-image"></i><input type="url" id="itemImageUrl" placeholder="https://example.com/image.jpg"></div>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ÙˆØµÙ</label>
                    <div class="input-wrapper"><i class="fas fa-align-left"></i><textarea id="itemDescription" rows="3" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬..."></textarea></div>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª (Ù…ÙØªØ§Ø­: Ù‚ÙŠÙ…Ø©, ÙƒÙ„ä¸€è¡Œ)</label>
                    <div class="input-wrapper"><i class="fas fa-list-ul"></i><textarea id="itemSpecs" rows="4" placeholder="Ù…Ø«Ø§Ù„:&#10;Ø§Ù„Ù…Ø§Ø±ÙƒØ©: XYZ&#10;Ø§Ù„Ù„ÙˆÙ†: Ø£Ø­Ù…Ø±&#10;Ø§Ù„Ù…Ù‚Ø§Ø³: ÙƒØ¨ÙŠØ±"></textarea></div>
                </div>
                <div class="form-group">
                    <label id="purchasePriceLabel">Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ ($)</label>
                    <div class="input-wrapper special"><i class="fas fa-dollar-sign"></i><input type="number" id="purchasePrice" step="0.01" min="0" required><button type="button" class="currency-switch" id="switchPurchaseCurrency" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø©"><i class="fas fa-exchange-alt"></i></button></div>
                    <div class="currency-info" id="purchasePriceSecondary"></div>
                </div>
                <div class="form-group">
                    <label id="salePriceLabel">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ ($)</label>
                    <div class="input-wrapper special"><i class="fas fa-dollar-sign"></i><input type="number" id="salePrice" step="0.01" min="0" required><button type="button" class="currency-switch" id="switchSaleCurrency" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø©"><i class="fas fa-exchange-alt"></i></button></div>
                    <div class="currency-info" id="salePriceSecondary"></div>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                    <div class="input-wrapper"><i class="fas fa-cubes"></i><input type="number" id="quantity" min="0" required></div>
                </div>
                <div class="form-actions"><button type="button" class="cancel-btn" id="cancelBtn">Ø¥Ù„ØºØ§Ø¡</button><button type="submit" class="save-btn">Ø­ÙØ¸</button></div>
            </form>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ -->
    <div class="modal" id="productDetailsModal">
        <div class="modal-content">
            <div class="modal-header"><h2>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</h2><button class="close-modal" id="closeDetailsModal">&times;</button></div>
            <div id="productDetailsContent" class="product-details-view"></div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ¹ (Ù…Ø­Ø³Ù‘Ù†) -->
    <div class="modal" id="sellModal">
        <div class="modal-content">
            <div class="modal-header"><h2>Ø¨ÙŠØ¹</h2><button class="close-modal" id="closeSellModal">&times;</button></div>
            <form id="sellForm">
                <div class="form-group"><label>Ø§Ù„Ù…Ù†ØªØ¬: <span id="sellProductName"></span></label></div>
                <div class="form-group">
                    <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                    <div class="input-wrapper"><i class="fas fa-cubes"></i><input type="number" id="sellQuantity" min="1" required></div>
                </div>
                <div class="form-group">
                    <label id="sellPriceLabel">Ø§Ù„Ø³Ø¹Ø± ($)</label>
                    <div class="input-wrapper special"><i class="fas fa-dollar-sign"></i><input type="number" id="sellPrice" step="0.01" required><button type="button" class="currency-switch" id="switchSellCurrency" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø©"><i class="fas fa-exchange-alt"></i></button></div>
                    <div class="currency-info" id="sellPriceSecondaryInfo"></div>
                </div>
                <div class="form-actions"><button type="button" class="cancel-btn" id="cancelSellBtn">Ø¥Ù„ØºØ§Ø¡</button><button type="submit" class="save-btn">ØªØ£ÙƒÙŠØ¯</button></div>
            </form>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ¹ (Ù…Ø­Ø³Ù‘Ù†) -->
    <div class="modal" id="editSaleModal">
        <div class="modal-content">
            <div class="modal-header"><h2>ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ¹</h2><button class="close-modal" id="closeEditSaleModal">&times;</button></div>
            <form id="editSaleForm">
                <input type="hidden" id="editSaleId">
                <input type="hidden" id="editOriginalItemId">
                <input type="hidden" id="editOriginalQuantity">
                <input type="hidden" id="editSaleCurrency">
                <div class="form-group"><label>Ø§Ù„Ù…Ù†ØªØ¬: <span id="editProductName"></span></label></div>
                <div class="form-group">
                    <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                    <div class="input-wrapper"><i class="fas fa-cubes"></i><input type="number" id="editQuantity" min="1" required></div>
                </div>
                <div class="form-group">
                    <label id="editPriceLabel">Ø§Ù„Ø³Ø¹Ø±</label>
                    <div class="input-wrapper special"><i class="fas fa-dollar-sign"></i><input type="number" id="editPrice" step="0.01" required><button type="button" class="currency-switch" id="switchEditCurrency" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø©"><i class="fas fa-exchange-alt"></i></button></div>
                    <div class="currency-info" id="editPriceSecondaryInfo"></div>
                </div>
                <div class="form-actions"><button type="button" class="cancel-btn" id="cancelEditSaleBtn">Ø¥Ù„ØºØ§Ø¡</button><button type="submit" class="save-btn">Ø­ÙØ¸</button></div>
            </form>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø³Ø¬Ù„ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
    <div class="modal" id="historyModal">
        <div class="modal-content" style="max-width: 480px;">
            <div class="modal-header"><h2>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2><button class="close-modal" id="closeHistoryModal">&times;</button></div>
            
            <div class="report-tabs">
                <button class="report-tab active" data-section="profits">ğŸ’° Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</button>
                <button class="report-tab" data-section="inventory">ğŸ“¦ Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</button>
                <button class="report-tab" data-section="sales">ğŸ›’ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</button>
                <button class="report-tab" data-section="activities">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</button>
            </div>

            <!-- Ù‚Ø³Ù… Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª -->
            <div class="report-section active" id="profitsSection">
                <div class="stats-cards">
                    <div class="stats-title"><i class="fas fa-chart-pie"></i> ØªÙØµÙŠÙ„ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</div>
                    <div class="profit-period">
                        <div class="period-item"><span class="period-label">Ø§Ù„ÙŠÙˆÙ…</span><span class="period-value" id="profitDayDetail">$0.00</span></div>
                        <div class="period-item"><span class="period-label">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</span><span class="period-value" id="profitWeekDetail">$0.00</span></div>
                        <div class="period-item"><span class="period-label">Ø§Ù„Ø´Ù‡Ø±</span><span class="period-value" id="profitMonthDetail">$0.00</span></div>
                        <div class="period-item"><span class="period-label">Ø§Ù„Ø³Ù†Ø©</span><span class="period-value" id="profitYearDetail">$0.00</span></div>
                    </div>
                </div>
            </div>

            <!-- Ù‚Ø³Ù… Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† -->
            <div class="report-section" id="inventorySection">
                <div class="stats-cards">
                    <div class="stats-title"><i class="fas fa-boxes"></i> Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div>
                    <div class="summary-grid">
                        <div class="summary-item"><span class="summary-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span><span class="summary-number" id="invTotalQty">0</span></div>
                        <div class="summary-item"><span class="summary-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù</span><span class="summary-number" id="invCategories">0</span></div>
                        <div class="summary-item"><span class="summary-label">Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„</span><span class="summary-number" id="invCapital">$0</span></div>
                        <div class="summary-item"><span class="summary-label">Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…Ø­ØªÙ…Ù„</span><span class="summary-number" id="invProfit">$0</span></div>
                    </div>
                </div>
            </div>

            <!-- Ù‚Ø³Ù… Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ù…Ù‚Ø³Ù‘Ù… Ø­Ø³Ø¨ Ø§Ù„ÙŠÙˆÙ…) -->
            <div class="report-section" id="salesLogSection">
                <div class="table-wrapper">
                    <table class="sales-table">
                        <thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„Ø±Ø¨Ø­</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                        <tbody id="salesLogBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Ù‚Ø³Ù… Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª -->
            <div class="report-section" id="activityLogSection">
                <div class="history-filter">
                    <button class="history-filter-btn active" data-action="all">Ø§Ù„ÙƒÙ„</button>
                    <button class="history-filter-btn" data-action="add">Ø¥Ø¶Ø§ÙØ©</button>
                    <button class="history-filter-btn" data-action="update">ØªØ¹Ø¯ÙŠÙ„</button>
                    <button class="history-filter-btn" data-action="delete">Ø­Ø°Ù</button>
                    <button class="clear-history-btn" id="clearHistoryBtn"><i class="fas fa-trash-alt"></i> Ù…Ø³Ø­</button>
                </div>
                <div class="table-wrapper">
                    <table class="history-table">
                        <thead><tr><th>#</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th></tr></thead>
                        <tbody id="historyTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø­Ø³Ù‘Ù†Ø©) -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header"><h2>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2><button class="close-modal" id="closeSettingsModal">&times;</button></div>
            <form id="settingsForm">
                <!-- Ù‚Ø³Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø© -->
                <div class="settings-section">
                    <div class="stats-title"><i class="fas fa-coins section-icon"></i> ğŸ’± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø©</div>
                    <div class="form-group"><label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©</label><div class="input-wrapper"><i class="fas fa-coins"></i><input type="text" id="secondaryCurrencyName" value="Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ"></div></div>
                    <div class="form-group"><label>Ø§Ù„Ø±Ù…Ø²</label><div class="input-wrapper"><i class="fas fa-hashtag"></i><input type="text" id="secondaryCurrencySymbol" value="ï·¼"></div></div>
                    <div class="form-group"><label>Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù (1$ =)</label><div class="input-wrapper"><i class="fas fa-exchange-alt"></i><input type="number" id="exchangeRate" step="0.01" value="3.75"></div></div>
                    <div class="form-group"><label>Ø¹Ù…Ù„Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ø´Ø±Ø§Ø¡</label>
                        <div class="radio-group">
                            <label><input type="radio" name="defaultInputCurrency" value="primary" checked> Ø¯ÙˆÙ„Ø§Ø±</label>
                            <label><input type="radio" name="defaultInputCurrency" value="secondary"> Ø«Ø§Ù†ÙˆÙŠØ©</label>
                        </div>
                    </div>
                    <div class="form-group"><label>Ø¹Ù…Ù„Ø© Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</label>
                        <div class="radio-group">
                            <label><input type="radio" name="defaultSellCurrency" value="primary" checked> Ø¯ÙˆÙ„Ø§Ø±</label>
                            <label><input type="radio" name="defaultSellCurrency" value="secondary"> Ø«Ø§Ù†ÙˆÙŠØ©</label>
                        </div>
                    </div>
                </div>

                <!-- Ù‚Ø³Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ¦Ø§Øª -->
                <div class="settings-section">
                    <div class="stats-title"><i class="fas fa-tags section-icon"></i> ğŸ·ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ¦Ø§Øª</div>
                    <div id="categoriesList" class="categories-list"></div>
                    <div class="add-category-form">
                        <div class="input-wrapper" style="flex:1;"><i class="fas fa-plus-circle"></i><input type="text" id="newCategoryName" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©"></div>
                        <button type="button" id="addCategoryBtn"><i class="fas fa-plus"></i></button>
                    </div>
                </div>

                <!-- Ù‚Ø³Ù… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØªØ¬Ø± -->
                <div class="settings-section">
                    <div class="stats-title"><i class="fas fa-store section-icon"></i> ğŸª Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±</div>
                    <div class="form-group"><label>Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±</label><div class="input-wrapper"><i class="fas fa-store-alt"></i><input type="text" id="storeName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±"></div></div>
                    <div class="form-group"><label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø¹ Ø£ÙŠÙ‚ÙˆÙ†Ø©)</label>
                        <div style="display: flex; gap: 5px;">
                            <div class="input-wrapper" style="flex:2;"><i class="fas fa-phone"></i><input type="text" id="storePhoneNumber" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ"></div>
                            <div class="input-wrapper" style="flex:1;"><i class="fas fa-icons"></i><input type="text" id="storePhoneIcon" placeholder="Ø£ÙŠÙ‚ÙˆÙ†Ø© (Ù…Ø«Ù„ fa-phone)" value="fa-phone"></div>
                        </div>
                    </div>
                    <div class="form-group"><label>Ø±Ø§Ø¨Ø· Ø®Ø±ÙŠØ·Ø© Ø¬ÙˆØ¬Ù„ (embed)</label><div class="input-wrapper"><i class="fas fa-map-marked-alt"></i><input type="url" id="storeMapUrl" placeholder="https://..."></div></div>
                    <div class="form-group"><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><div class="input-wrapper"><i class="fas fa-map-pin"></i><input type="text" id="storeAddress" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"></div></div>
                </div>

                <!-- Ù‚Ø³Ù… Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ -->
                <div class="settings-section">
                    <div class="stats-title"><i class="fas fa-share-alt section-icon"></i> ğŸ”— Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ</div>
                    <div id="socialLinksList" class="social-links-list"></div>
                    <button type="button" id="addSocialBtn" class="add-social-btn"><i class="fas fa-plus"></i></button>
                </div>

                <div class="form-actions">
                    <button type="button" class="cancel-btn" id="cancelSettingsBtn">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="save-btn">Ø­ÙØ¸</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // -------------------- ØªÙƒÙˆÙŠÙ† Firebase --------------------
    const firebaseConfig = {
        apiKey: "AIzaSyBeJ0sbdCqz60a-yqzuZSt6QstDhR3TRtM",
        authDomain: "profit-zone-e03c6.firebaseapp.com",
        databaseURL: "https://profit-zone-e03c6-default-rtdb.firebaseio.com",
        projectId: "profit-zone-e03c6",
        storageBucket: "profit-zone-e03c6.firebasestorage.app",
        messagingSenderId: "306955059136",
        appId: "1:306955059136:web:a450be9721f4a2db0d1225"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // -------------------- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© --------------------
    let items = [];
    let sales = [];
    let activityLog = [];
    let categories = [];
    let currentItemId = null;
    let isEditing = false;
    let currentFilter = 'all';
    let deleteConfirmId = null;
    let itemVisibility = {};

    let tempPurchaseCurrency = false;
    let tempSaleCurrency = false;
    let tempSellCurrency = false;
    let tempEditCurrency = false;

    let currencySettings = {
        secondaryCurrencyName: "Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ",
        secondaryCurrencySymbol: "ï·¼",
        exchangeRate: 3.75,
        defaultInputCurrency: "primary",
        defaultSellCurrency: "primary"
    };

    let storeInfo = {
        name: '',
        isOpen: false,
        phone: { number: '', icon: 'fa-phone' },
        mapUrl: '',
        address: '',
        socialLinks: []
    };

    // Ø¹Ù†Ø§ØµØ± DOM
    const connectionStatus = document.getElementById('connectionStatus');
    const itemsList = document.getElementById('itemsList');
    const searchInput = document.getElementById('searchInput');
    const addItemBtn = document.getElementById('addItemBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const historyBtn = document.getElementById('historyBtn');
    const storeStatusBtn = document.getElementById('storeStatusBtn');

    // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª
    const itemModal = document.getElementById('itemModal');
    const productDetailsModal = document.getElementById('productDetailsModal');
    const sellModal = document.getElementById('sellModal');
    const editSaleModal = document.getElementById('editSaleModal');
    const historyModal = document.getElementById('historyModal');
    const settingsModal = document.getElementById('settingsModal');
    const closeModal = document.getElementById('closeModal');
    const closeSellModal = document.getElementById('closeSellModal');
    const closeEditSaleModal = document.getElementById('closeEditSaleModal');
    const closeHistoryModal = document.getElementById('closeHistoryModal');
    const closeSettingsModal = document.getElementById('closeSettingsModal');
    const closeDetailsModal = document.getElementById('closeDetailsModal');
    const cancelBtn = document.getElementById('cancelBtn');
    const cancelSellBtn = document.getElementById('cancelSellBtn');
    const cancelEditSaleBtn = document.getElementById('cancelEditSaleBtn');
    const cancelSettingsBtn = document.getElementById('cancelSettingsBtn');

    const itemForm = document.getElementById('itemForm');
    const sellForm = document.getElementById('sellForm');
    const editSaleForm = document.getElementById('editSaleForm');
    const settingsForm = document.getElementById('settingsForm');

    const modalTitle = document.getElementById('modalTitle');
    const itemName = document.getElementById('itemName');
    const itemCategory = document.getElementById('itemCategory');
    const itemImageUrl = document.getElementById('itemImageUrl');
    const itemDescription = document.getElementById('itemDescription');
    const itemSpecs = document.getElementById('itemSpecs');
    const purchasePrice = document.getElementById('purchasePrice');
    const salePrice = document.getElementById('salePrice');
    const quantity = document.getElementById('quantity');
    const purchasePriceLabel = document.getElementById('purchasePriceLabel');
    const salePriceLabel = document.getElementById('salePriceLabel');
    const purchasePriceSecondary = document.getElementById('purchasePriceSecondary');
    const salePriceSecondary = document.getElementById('salePriceSecondary');

    const productDetailsContent = document.getElementById('productDetailsContent');

    const storeNameInput = document.getElementById('storeName');
    const storePhoneNumber = document.getElementById('storePhoneNumber');
    const storePhoneIcon = document.getElementById('storePhoneIcon');
    const storeMapUrl = document.getElementById('storeMapUrl');
    const storeAddress = document.getElementById('storeAddress');
    const socialLinksList = document.getElementById('socialLinksList');
    const addSocialBtn = document.getElementById('addSocialBtn');

    const switchPurchaseCurrency = document.getElementById('switchPurchaseCurrency');
    const switchSaleCurrency = document.getElementById('switchSaleCurrency');
    const switchSellCurrency = document.getElementById('switchSellCurrency');
    const switchEditCurrency = document.getElementById('switchEditCurrency');

    const categoriesList = document.getElementById('categoriesList');
    const newCategoryName = document.getElementById('newCategoryName');
    const addCategoryBtn = document.getElementById('addCategoryBtn');

    // Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
    const profitDayDetail = document.getElementById('profitDayDetail');
    const profitWeekDetail = document.getElementById('profitWeekDetail');
    const profitMonthDetail = document.getElementById('profitMonthDetail');
    const profitYearDetail = document.getElementById('profitYearDetail');
    const invTotalQty = document.getElementById('invTotalQty');
    const invCategories = document.getElementById('invCategories');
    const invCapital = document.getElementById('invCapital');
    const invProfit = document.getElementById('invProfit');
    const salesLogBody = document.getElementById('salesLogBody');
    const historyTableBody = document.getElementById('historyTableBody');
    const clearHistoryBtn = document.getElementById('clearHistoryBtn');
    const historyFilter = document.querySelector('.history-filter');
    const reportTabs = document.querySelectorAll('.report-tab');

    // -------------------- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© --------------------
    function updateConnectionStatus(status, message) {
        connectionStatus.style.display = 'flex';
        connectionStatus.className = 'connection-status ' + status;
        connectionStatus.innerHTML = `<i class="fas ${status==='online-status'?'fa-wifi':status==='offline-status'?'fa-wifi-slash':'fa-sync-alt fa-spin'}"></i><span>${message || ''}</span>`;
        if (status === 'online-status') setTimeout(() => connectionStatus.style.display = 'none', 2500);
    }

    function formatPrimary(amount) { return amount.toFixed(2); }
    function formatSecondary(amount) { return Number.isInteger(amount) ? amount : amount.toFixed(2).replace(/\.0+$/, ''); }
    function convertToSecondary(amount) { return amount * currencySettings.exchangeRate; }
    function convertToPrimary(sec) { return sec / currencySettings.exchangeRate; }
    function calculateProfitPercent(purchase, sale) {
        if (purchase === 0) return sale > 0 ? 100 : 0;
        return ((sale - purchase) / purchase * 100).toFixed(2);
    }

    // ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ø¹ ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø§Ù„ÙŠÙˆÙ… Ù„ÙŠØ¨Ø¯Ø£ Ù…Ù† 00:00
    function updateStats() {
        let totalCapital = 0, totalProfit = 0, totalQty = 0;
        items.forEach(i => {
            totalCapital += i.purchasePrice * i.quantity;
            totalProfit += (i.salePrice - i.purchasePrice) * i.quantity;
            totalQty += i.quantity;
        });
        invCategories.textContent = items.length;
        invTotalQty.textContent = totalQty;
        invCapital.textContent = `$${formatPrimary(totalCapital)}`;
        invProfit.textContent = `$${formatPrimary(totalProfit)}`;

        const now = Date.now();
        // Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ (00:00)
        const startOfToday = new Date();
        startOfToday.setHours(0, 0, 0, 0);
        const startToday = startOfToday.getTime();

        const d = 86400000, w = 7*d, mo = 30*d, y = 365*d;
        let day = 0, week = 0, month = 0, year = 0;
        sales.forEach(s => {
            if (s.timestamp >= startToday) day += s.profit; // Ù…Ù† Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ÙŠÙˆÙ… Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†
            if (now - s.timestamp <= w) week += s.profit;
            if (now - s.timestamp <= mo) month += s.profit;
            if (now - s.timestamp <= y) year += s.profit;
        });
        profitDayDetail.textContent = `$${formatPrimary(day)}`;
        profitWeekDetail.textContent = `$${formatPrimary(week)}`;
        profitMonthDetail.textContent = `$${formatPrimary(month)}`;
        profitYearDetail.textContent = `$${formatPrimary(year)}`;
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù‚Ø·Ø¹Ø©
    function updateSecondaryPrices() {
        let p = parseFloat(purchasePrice.value) || 0;
        let s = parseFloat(salePrice.value) || 0;
        if (tempPurchaseCurrency) {
            const pPrimary = convertToPrimary(p).toFixed(2);
            purchasePriceSecondary.innerText = `${formatSecondary(p)} ${currencySettings.secondaryCurrencySymbol} (â‰ˆ $${pPrimary})`;
        } else {
            purchasePriceSecondary.innerText = `${formatSecondary(convertToSecondary(p))} ${currencySettings.secondaryCurrencySymbol}`;
        }
        if (tempSaleCurrency) {
            const sPrimary = convertToPrimary(s).toFixed(2);
            salePriceSecondary.innerText = `${formatSecondary(s)} ${currencySettings.secondaryCurrencySymbol} (â‰ˆ $${sPrimary})`;
        } else {
            salePriceSecondary.innerText = `${formatSecondary(convertToSecondary(s))} ${currencySettings.secondaryCurrencySymbol}`;
        }
    }

    function updatePriceLabels() {
        purchasePriceLabel.innerHTML = `Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ <small style="color:#666;">(${tempPurchaseCurrency ? currencySettings.secondaryCurrencySymbol : '$'})</small>`;
        salePriceLabel.innerHTML = `Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ <small style="color:#666;">(${tempSaleCurrency ? currencySettings.secondaryCurrencySymbol : '$'})</small>`;
    }

    // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ¦Ø§Øª ÙÙŠ Ø§Ù„Ù€ select Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ù†ØªØ¬
    function renderCategoriesSelect() {
        let options = '<option value="">Ø¨Ø¯ÙˆÙ† ÙØ¦Ø©</option>';
        categories.forEach(cat => {
            options += `<option value="${cat.id}">${cat.name}</option>`;
        });
        itemCategory.innerHTML = options;
    }

    function renderCategoriesList() {
        let html = '';
        categories.forEach(cat => {
            html += `<div class="category-item">
                <span class="category-name">${cat.name}</span>
                <button class="delete-category" data-id="${cat.id}"><i class="fas fa-trash"></i></button>
            </div>`;
        });
        categoriesList.innerHTML = html;
        document.querySelectorAll('.delete-category').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const id = btn.dataset.id;
                deleteCategory(id);
            });
        });
    }

    async function deleteCategory(categoryId) {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©ØŸ')) return;
        const used = items.some(item => item.category === categoryId);
        if (used) {
            alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù ÙØ¦Ø© Ù…Ø³ØªØ®Ø¯Ù…Ø© ÙÙŠ Ù…Ù†ØªØ¬Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.');
            return;
        }
        try {
            await database.ref('categories/' + categoryId).remove();
            categories = categories.filter(c => c.id !== categoryId);
            renderCategoriesSelect();
            renderCategoriesList();
            await addToActivityLog('settings', `Ø­Ø°Ù ÙØ¦Ø© ${categoryId}`);
        } catch (e) {
            alert('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ÙØ¦Ø©');
            console.error(e);
        }
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Ù…Ø¹ Ø²Ø± Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ)
    function displayItems(filtered = items) {
        const sorted = [...filtered].sort((a,b) => a.name.localeCompare(b.name, 'ar'));
        if (sorted.length === 0) {
            itemsList.innerHTML = `<div class="empty-state"><i class="fas fa-box-open fa-3x"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</p><p>Ø£Ø¶Ù Ù…Ù†ØªØ¬Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹</p></div>`;
            updateStats(); return;
        }
        let html = '';
        sorted.forEach((item, index) => {
            const profit = calculateProfitPercent(item.purchasePrice, item.salePrice);
            const profitClass = profit >= 0 ? 'profit-positive' : 'profit-negative';
            const profitSign = profit >= 0 ? '+' : '';
            const purchaseSec = formatSecondary(convertToSecondary(item.purchasePrice));
            const saleSec = formatSecondary(convertToSecondary(item.salePrice));
            let cardClass = '';
            if (item.quantity === 0) cardClass = 'out-of-stock';
            else if (item.quantity <= 2) cardClass = 'low-stock';

            const isConfirming = deleteConfirmId === item.id;
            const isVisible = itemVisibility[item.id] || false;
            const category = categories.find(c => c.id === item.category);
            const categoryName = category ? category.name : '';

            html += `<div class="product-card ${cardClass}" data-id="${item.id}">
                <div class="product-index-outer">${index+1}</div>
                <div class="product-details-outer info-icon" data-id="${item.id}" title="Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„">
                    <i class="fas fa-info"></i>
                </div>
                <div class="card-header">
                    <div class="product-title">
                        <span class="product-name">${item.name}</span>
                        ${categoryName ? `<span class="product-category">${categoryName}</span>` : ''}
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <div class="product-meta">
                            <span class="meta-item"><i class="fas fa-cubes"></i> ${item.quantity}</span>
                            <span class="meta-item profit-badge-small ${profitClass} ${isVisible ? '' : 'blur-price'}">${profitSign}${profit}%</span>
                        </div>
                        <button class="icon-btn eye-icon" data-id="${item.id}" title="${isVisible ? 'Ø¥Ø®ÙØ§Ø¡' : 'Ø¥Ø¸Ù‡Ø§Ø±'} Ø§Ù„ØªÙØ§ØµÙŠÙ„">
                            <i class="fas ${isVisible ? 'fa-eye' : 'fa-eye-slash'}"></i>
                        </button>
                    </div>
                </div>
                <div class="price-row">
                    <div class="price-col purchase-price">
                        <div class="price-label">Ø´Ø±Ø§Ø¡</div>
                        <div class="primary-price ${isVisible ? '' : 'blur-price'}">$${formatPrimary(item.purchasePrice)}</div>
                        <div class="secondary-price ${isVisible ? '' : 'blur-price'}">${purchaseSec} ${currencySettings.secondaryCurrencySymbol}</div>
                    </div>
                    <div class="price-col sale-price">
                        <div class="price-label">Ø¨ÙŠØ¹</div>
                        <div class="primary-price">$${formatPrimary(item.salePrice)}</div>
                        <div class="secondary-price">${saleSec} ${currencySettings.secondaryCurrencySymbol}</div>
                    </div>
                </div>
                <div class="action-buttons">
                    ${!isConfirming ? 
                        `<button class="action-btn sell" data-id="${item.id}" ${item.quantity===0?'disabled':''}><i class="fas fa-shopping-cart"></i> Ø¨ÙŠØ¹</button>
                         <button class="action-btn edit" data-id="${item.id}"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„</button>
                         <button class="action-btn delete" data-id="${item.id}"><i class="fas fa-trash-alt"></i> Ø­Ø°Ù</button>`
                        :
                        `<button class="action-btn confirm-delete" data-id="${item.id}"><i class="fas fa-check"></i> ØªØ£ÙƒÙŠØ¯</button>
                         <button class="action-btn cancel-delete" data-id="${item.id}"><i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡</button>`
                    }
                </div>
            </div>`;
        });
        itemsList.innerHTML = html;
        updateStats();

        document.querySelectorAll('.sell').forEach(b => b.addEventListener('click', e => openSellModal(e.currentTarget.dataset.id)));
        document.querySelectorAll('.edit').forEach(b => b.addEventListener('click', e => editItem(e.currentTarget.dataset.id)));
        document.querySelectorAll('.delete').forEach(b => b.addEventListener('click', e => {
            deleteConfirmId = e.currentTarget.dataset.id;
            displayItems(searchInput.value ? items.filter(i => i.name.toLowerCase().includes(searchInput.value.toLowerCase())) : items);
        }));
        document.querySelectorAll('.confirm-delete').forEach(b => b.addEventListener('click', e => performDelete(e.currentTarget.dataset.id)));
        document.querySelectorAll('.cancel-delete').forEach(b => b.addEventListener('click', e => {
            deleteConfirmId = null;
            displayItems(searchInput.value ? items.filter(i => i.name.toLowerCase().includes(searchInput.value.toLowerCase())) : items);
        }));
        document.querySelectorAll('.eye-icon').forEach(btn => {
            btn.addEventListener('click', e => {
                e.stopPropagation();
                const id = btn.dataset.id;
                itemVisibility[id] = !itemVisibility[id];
                displayItems(searchInput.value ? items.filter(i => i.name.toLowerCase().includes(searchInput.value.toLowerCase())) : items);
            });
        });
        document.querySelectorAll('.info-icon').forEach(btn => {
            btn.addEventListener('click', e => {
                e.stopPropagation();
                const id = btn.dataset.id;
                showProductDetails(id);
            });
        });
    }

    // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ù…ÙˆØ¯Ø§Ù„
    function showProductDetails(itemId) {
        const item = items.find(i => i.id === itemId);
        if (!item) return;
        
        let specsHtml = '';
        if (item.specs) {
            const lines = item.specs.split('\n').filter(line => line.trim() !== '');
            if (lines.length > 0) {
                specsHtml = '<table class="specs-table"><tr><th>Ø§Ù„Ø®Ø§ØµÙŠØ©</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th></tr>';
                lines.forEach(line => {
                    const parts = line.split(':');
                    if (parts.length >= 2) {
                        specsHtml += `<tr><td>${parts[0].trim()}</td><td>${parts.slice(1).join(':').trim()}</td></tr>`;
                    } else {
                        specsHtml += `<tr><td colspan="2">${line}</td></tr>`;
                    }
                });
                specsHtml += '</table>';
            }
        }

        const imageHtml = item.imageUrl ? `<img src="${item.imageUrl}" alt="${item.name}" onerror="this.src='https://via.placeholder.com/200?text=No+Image'">` : '<div style="background:#f1f5f9; height:150px; display:flex; align-items:center; justify-content:center;"><i class="fas fa-image fa-3x" style="color:#94a3b8;"></i></div>';
        
        productDetailsContent.innerHTML = `
            ${imageHtml}
            <h3>${item.name}</h3>
            <p><strong>Ø§Ù„ÙˆØµÙ:</strong> ${item.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p>
            ${specsHtml}
        `;
        productDetailsModal.style.display = 'flex';
    }

    // -------------------- Ø¹Ù…Ù„ÙŠØ§Øª Firebase Ùˆ localStorage --------------------
    function saveAllToLocalStorage() {
        try {
            localStorage.setItem('items', JSON.stringify(items));
            localStorage.setItem('sales', JSON.stringify(sales));
            localStorage.setItem('activityLog', JSON.stringify(activityLog));
            localStorage.setItem('currencySettings', JSON.stringify(currencySettings));
            localStorage.setItem('itemVisibility', JSON.stringify(itemVisibility));
            localStorage.setItem('categories', JSON.stringify(categories));
            localStorage.setItem('storeInfo', JSON.stringify(storeInfo));
        } catch (e) { console.warn(e); }
    }

    function loadAllFromLocalStorage() {
        try {
            if (localStorage.getItem('items')) items = JSON.parse(localStorage.getItem('items'));
            if (localStorage.getItem('sales')) sales = JSON.parse(localStorage.getItem('sales'));
            if (localStorage.getItem('activityLog')) activityLog = JSON.parse(localStorage.getItem('activityLog'));
            if (localStorage.getItem('currencySettings')) currencySettings = JSON.parse(localStorage.getItem('currencySettings'));
            if (localStorage.getItem('itemVisibility')) itemVisibility = JSON.parse(localStorage.getItem('itemVisibility'));
            if (localStorage.getItem('categories')) categories = JSON.parse(localStorage.getItem('categories'));
            if (localStorage.getItem('storeInfo')) storeInfo = JSON.parse(localStorage.getItem('storeInfo'));
            renderCategoriesSelect();
            renderCategoriesList();
            displayItems();
            updateStats();
            renderSocialLinksList();
            updateStoreStatusButton();
        } catch (e) { console.warn(e); }
    }

    async function fetchItems() {
        try {
            const snap = await database.ref('items').once('value');
            items = snap.val() ? Object.keys(snap.val()).map(k => ({ id: k, ...snap.val()[k] })) : [];
            saveAllToLocalStorage();
            displayItems();
        } catch (e) {
            console.error(e);
            loadAllFromLocalStorage();
            updateConnectionStatus('offline-status', 'Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©');
        }
    }

    async function fetchSales() {
        try {
            const snap = await database.ref('sales').once('value');
            sales = snap.val() ? Object.keys(snap.val()).map(k => ({ saleId: k, ...snap.val()[k] })).sort((a,b)=>b.timestamp-a.timestamp) : [];
            saveAllToLocalStorage();
            updateStats();
        } catch (e) { console.warn(e); }
    }

    async function fetchActivityLog() {
        try {
            const snap = await database.ref('activityLog').once('value');
            activityLog = snap.val() ? Object.values(snap.val()).sort((a,b)=>b.timestamp-a.timestamp) : [];
            saveAllToLocalStorage();
        } catch (e) { console.warn(e); }
    }

    async function fetchCurrencySettings() {
        try {
            const snap = await database.ref('currencySettings').once('value');
            if (snap.val()) currencySettings = { ...currencySettings, ...snap.val() };
            saveAllToLocalStorage();
            document.getElementById('secondaryCurrencyName').value = currencySettings.secondaryCurrencyName;
            document.getElementById('secondaryCurrencySymbol').value = currencySettings.secondaryCurrencySymbol;
            document.getElementById('exchangeRate').value = currencySettings.exchangeRate;
            document.querySelector(`input[name="defaultInputCurrency"][value="${currencySettings.defaultInputCurrency}"]`).checked = true;
            document.querySelector(`input[name="defaultSellCurrency"][value="${currencySettings.defaultSellCurrency}"]`).checked = true;
            tempPurchaseCurrency = (currencySettings.defaultInputCurrency === 'secondary');
            tempSaleCurrency = (currencySettings.defaultInputCurrency === 'secondary');
            tempSellCurrency = (currencySettings.defaultSellCurrency === 'secondary');
            updatePriceLabels();
            updateSecondaryPrices();
        } catch (e) { console.warn(e); }
    }

    async function fetchCategories() {
        try {
            const snap = await database.ref('categories').once('value');
            categories = snap.val() ? Object.keys(snap.val()).map(k => ({ id: k, name: snap.val()[k] })) : [];
            saveAllToLocalStorage();
            renderCategoriesSelect();
            renderCategoriesList();
        } catch (e) { console.warn(e); }
    }

    async function fetchStoreInfo() {
        try {
            const snap = await database.ref('storeInfo').once('value');
            if (snap.val()) storeInfo = { ...storeInfo, ...snap.val() };
            saveAllToLocalStorage();
            storeNameInput.value = storeInfo.name || '';
            storePhoneNumber.value = storeInfo.phone?.number || '';
            storePhoneIcon.value = storeInfo.phone?.icon || 'fa-phone';
            storeMapUrl.value = storeInfo.mapUrl || '';
            storeAddress.value = storeInfo.address || '';
            renderSocialLinksList();
            updateStoreStatusButton();
        } catch (e) { console.warn(e); }
    }

    function renderSocialLinksList() {
        let html = '';
        storeInfo.socialLinks.forEach((link, index) => {
            html += `
                <div class="social-item" data-index="${index}">
                    <div class="input-wrapper"><i class="fas fa-link"></i><input type="text" placeholder="Ø§Ù„Ø±Ø§Ø¨Ø·" class="social-url" value="${link.url || ''}"></div>
                    <div class="input-wrapper"><i class="fas fa-icons"></i><input type="text" placeholder="Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© (Ù…Ø«Ù„ fa-facebook)" class="social-icon" value="${link.icon || ''}"></div>
                    <button class="delete-social" data-index="${index}"><i class="fas fa-trash"></i></button>
                </div>
            `;
        });
        socialLinksList.innerHTML = html;
        document.querySelectorAll('.delete-social').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const index = btn.dataset.index;
                storeInfo.socialLinks.splice(index, 1);
                renderSocialLinksList();
            });
        });
    }

    async function saveStoreInfo() {
        storeInfo.name = storeNameInput.value;
        storeInfo.phone = {
            number: storePhoneNumber.value,
            icon: storePhoneIcon.value || 'fa-phone'
        };
        storeInfo.mapUrl = storeMapUrl.value;
        storeInfo.address = storeAddress.value;
        const items = document.querySelectorAll('.social-item');
        storeInfo.socialLinks = [];
        items.forEach(item => {
            const url = item.querySelector('.social-url')?.value;
            const icon = item.querySelector('.social-icon')?.value;
            if (url) {
                storeInfo.socialLinks.push({ url, icon: icon || 'fa-link' });
            }
        });
        try {
            await database.ref('storeInfo').set(storeInfo);
            saveAllToLocalStorage();
            updateConnectionStatus('online-status', 'ØªÙ… Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±');
        } catch (e) {
            alert('ÙØ´Ù„ Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±');
            console.error(e);
        }
    }

    // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØªØ¬Ø±
    function updateStoreStatusButton() {
        if (storeInfo.isOpen) {
            storeStatusBtn.className = 'header-btn store-status-open';
            storeStatusBtn.innerHTML = '<i class="fas fa-store"></i>';
            storeStatusBtn.title = 'Ø§Ù„Ù…ØªØ¬Ø± Ù…ÙØªÙˆØ­ (Ø§Ø¶ØºØ· Ù„Ù„Ø¥ØºÙ„Ø§Ù‚)';
        } else {
            storeStatusBtn.className = 'header-btn store-status-closed';
            storeStatusBtn.innerHTML = '<i class="fas fa-store-slash"></i>';
            storeStatusBtn.title = 'Ø§Ù„Ù…ØªØ¬Ø± Ù…ØºÙ„Ù‚ (Ø§Ø¶ØºØ· Ù„Ù„ÙØªØ­)';
        }
    }

    // ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØªØ¬Ø±
    async function toggleStoreStatus() {
        storeInfo.isOpen = !storeInfo.isOpen;
        try {
            await database.ref('storeInfo/isOpen').set(storeInfo.isOpen);
            saveAllToLocalStorage();
            updateStoreStatusButton();
            updateConnectionStatus('online-status', storeInfo.isOpen ? 'Ø§Ù„Ù…ØªØ¬Ø± Ù…ÙØªÙˆØ­' : 'Ø§Ù„Ù…ØªØ¬Ø± Ù…ØºÙ„Ù‚');
        } catch (e) {
            alert('ÙØ´Ù„ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØªØ¬Ø±');
            console.error(e);
        }
    }

    addSocialBtn.addEventListener('click', () => {
        storeInfo.socialLinks.push({ url: '', icon: '' });
        renderSocialLinksList();
    });

    async function saveItemToFirebase(item) {
        const { id, ...data } = item;
        await database.ref('items/' + id).set(data);
        saveAllToLocalStorage();
    }

    async function deleteItemFromFirebase(id) {
        await database.ref('items/' + id).remove();
        saveAllToLocalStorage();
    }

    function generateActivityId() { return 'act_' + Date.now() + '_' + Math.random().toString(36).substr(2,9); }
    function formatDateTime(date) { return date.toLocaleString('ar-EG'); }

    async function addToActivityLog(actionType, details, itemData = null) {
        const timestamp = Date.now();
        const activityId = generateActivityId();
        const activity = { activityId, actionType, details, timestamp, dateTime: formatDateTime(new Date(timestamp)), itemData };
        activityLog.unshift(activity);
        try {
            await database.ref('activityLog/' + activityId).set(activity);
            saveAllToLocalStorage();
        } catch (e) { console.warn(e); }
        if (historyModal.style.display === 'flex' && activityLogSection.style.display !== 'none') displayActivityLog();
    }

    // -------------------- Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª --------------------
    function addItem() {
        currentItemId = null; isEditing = false;
        itemForm.reset();
        tempPurchaseCurrency = (currencySettings.defaultInputCurrency === 'secondary');
        tempSaleCurrency = (currencySettings.defaultInputCurrency === 'secondary');
        modalTitle.innerText = 'Ø¥Ø¶Ø§ÙØ© Ù‚Ø·Ø¹Ø©';
        updatePriceLabels();
        updateSecondaryPrices();
        renderCategoriesSelect();
        itemModal.style.display = 'flex';
    }

    function editItem(itemId) {
        const item = items.find(i => i.id === itemId);
        if (!item) return;
        currentItemId = itemId; isEditing = true;
        itemName.value = item.name;
        itemCategory.value = item.category || '';
        itemImageUrl.value = item.imageUrl || '';
        itemDescription.value = item.description || '';
        itemSpecs.value = item.specs || '';
        tempPurchaseCurrency = (currencySettings.defaultInputCurrency === 'secondary');
        tempSaleCurrency = (currencySettings.defaultInputCurrency === 'secondary');
        if (tempPurchaseCurrency) {
            purchasePrice.value = Math.round(convertToSecondary(item.purchasePrice));
        } else {
            purchasePrice.value = item.purchasePrice;
        }
        if (tempSaleCurrency) {
            salePrice.value = Math.round(convertToSecondary(item.salePrice));
        } else {
            salePrice.value = item.salePrice;
        }
        quantity.value = item.quantity;
        modalTitle.innerText = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø·Ø¹Ø©';
        updatePriceLabels();
        updateSecondaryPrices();
        renderCategoriesSelect();
        itemModal.style.display = 'flex';
    }

    async function performDelete(itemId) {
        const item = items.find(i => i.id === itemId);
        if (!item) return;
        try {
            await deleteItemFromFirebase(itemId);
            items = items.filter(i => i.id !== itemId);
            await addToActivityLog('delete', `Ø­Ø°Ù "${item.name}"`, item);
            deleteConfirmId = null;
            displayItems();
            updateConnectionStatus('online-status', 'ØªÙ… Ø§Ù„Ø­Ø°Ù');
        } catch (e) {
            alert('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù');
            console.error(e);
        }
    }

    itemForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = itemName.value.trim();
        const categoryId = itemCategory.value || null;
        const imageUrl = itemImageUrl.value.trim() || null;
        const description = itemDescription.value.trim() || null;
        const specs = itemSpecs.value.trim() || null;
        let purchase, sale;
        if (tempPurchaseCurrency) {
            const pSec = parseFloat(purchasePrice.value);
            if (isNaN(pSec) || pSec < 0) return alert('Ù‚ÙŠÙ…Ø© Ø´Ø±Ø§Ø¡ ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
            purchase = convertToPrimary(pSec);
        } else {
            purchase = parseFloat(purchasePrice.value);
        }
        if (tempSaleCurrency) {
            const sSec = parseFloat(salePrice.value);
            if (isNaN(sSec) || sSec < 0) return alert('Ù‚ÙŠÙ…Ø© Ø¨ÙŠØ¹ ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
            sale = convertToPrimary(sSec);
        } else {
            sale = parseFloat(salePrice.value);
        }
        const qty = parseInt(quantity.value);
        if (!name || isNaN(purchase) || isNaN(sale) || isNaN(qty) || purchase < 0 || sale < 0 || qty < 0)
            return alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');

        try {
            if (isEditing) {
                const item = items.find(i => i.id === currentItemId);
                if (!item) return;
                item.name = name;
                item.category = categoryId;
                item.imageUrl = imageUrl;
                item.description = description;
                item.specs = specs;
                item.purchasePrice = purchase;
                item.salePrice = sale;
                item.quantity = qty;
                item.updatedAt = Date.now();
                await saveItemToFirebase(item);
                await addToActivityLog('update', `ØªØ¹Ø¯ÙŠÙ„ "${name}"`, item);
            } else {
                const newId = 'item_' + Date.now() + '_' + Math.random().toString(36).substr(2,9);
                const newItem = { id: newId, name, category: categoryId, imageUrl, description, specs, purchasePrice: purchase, salePrice: sale, quantity: qty, createdAt: Date.now(), updatedAt: Date.now() };
                await saveItemToFirebase(newItem);
                items.push(newItem);
                await addToActivityLog('add', `Ø¥Ø¶Ø§ÙØ© "${name}"`, newItem);
            }
            displayItems();
            itemModal.style.display = 'none';
            updateConnectionStatus('online-status', isEditing ? 'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«' : 'ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
        } catch (e) {
            alert('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸');
            console.error(e);
        }
    });

    switchPurchaseCurrency.addEventListener('click', () => {
        tempPurchaseCurrency = !tempPurchaseCurrency;
        const currentVal = parseFloat(purchasePrice.value) || 0;
        if (tempPurchaseCurrency) {
            purchasePrice.value = Math.round(convertToSecondary(currentVal));
        } else {
            purchasePrice.value = convertToPrimary(currentVal).toFixed(2);
        }
        updatePriceLabels();
        updateSecondaryPrices();
    });

    switchSaleCurrency.addEventListener('click', () => {
        tempSaleCurrency = !tempSaleCurrency;
        const currentVal = parseFloat(salePrice.value) || 0;
        if (tempSaleCurrency) {
            salePrice.value = Math.round(convertToSecondary(currentVal));
        } else {
            salePrice.value = convertToPrimary(currentVal).toFixed(2);
        }
        updatePriceLabels();
        updateSecondaryPrices();
    });

    // -------------------- Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¨ÙŠØ¹ --------------------
    function openSellModal(itemId) {
        const item = items.find(i => i.id === itemId);
        if (!item) return;
        sellProductName.innerText = item.name;
        sellQuantity.value = 1;
        sellQuantity.max = item.quantity;
        tempSellCurrency = (currencySettings.defaultSellCurrency === 'secondary');
        if (tempSellCurrency) {
            sellPriceLabel.innerHTML = `Ø§Ù„Ø³Ø¹Ø± <small>(${currencySettings.secondaryCurrencySymbol})</small>`;
            sellPrice.value = Math.round(convertToSecondary(item.salePrice));
            updateSecondarySellPrice();
        } else {
            sellPriceLabel.innerHTML = `Ø§Ù„Ø³Ø¹Ø± <small>($)</small>`;
            sellPrice.value = item.salePrice;
            updateSecondarySellPrice();
        }
        sellForm.dataset.itemId = itemId;
        sellModal.style.display = 'flex';
    }

    function updateSecondarySellPrice() {
        const val = parseFloat(sellPrice.value) || 0;
        if (tempSellCurrency) {
            const primary = convertToPrimary(val);
            sellPriceSecondaryInfo.innerText = `ØªØ¹Ø§Ø¯Ù„ $${formatPrimary(primary)}`;
        } else {
            const sec = convertToSecondary(val);
            sellPriceSecondaryInfo.innerText = `ØªØ¹Ø§Ø¯Ù„ ${formatSecondary(sec)} ${currencySettings.secondaryCurrencySymbol}`;
        }
    }

    switchSellCurrency.addEventListener('click', () => {
        tempSellCurrency = !tempSellCurrency;
        const currentVal = parseFloat(sellPrice.value) || 0;
        if (tempSellCurrency) {
            sellPrice.value = Math.round(convertToSecondary(currentVal));
            sellPriceLabel.innerHTML = `Ø§Ù„Ø³Ø¹Ø± <small>(${currencySettings.secondaryCurrencySymbol})</small>`;
        } else {
            sellPrice.value = convertToPrimary(currentVal).toFixed(2);
            sellPriceLabel.innerHTML = `Ø§Ù„Ø³Ø¹Ø± <small>($)</small>`;
        }
        updateSecondarySellPrice();
    });

    sellForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const itemId = sellForm.dataset.itemId;
        const item = items.find(i => i.id === itemId);
        if (!item) return;
        const qty = parseInt(sellQuantity.value);
        if (qty <= 0 || qty > item.quantity) return alert('ÙƒÙ…ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­Ø©');
        let pricePrimary;
        if (tempSellCurrency) {
            const sec = parseFloat(sellPrice.value);
            if (isNaN(sec) || sec < 0) return alert('Ø³Ø¹Ø± ØºÙŠØ± ØµØ§Ù„Ø­');
            pricePrimary = convertToPrimary(sec);
        } else {
            pricePrimary = parseFloat(sellPrice.value);
        }
        const profit = (pricePrimary - item.purchasePrice) * qty;
        const sale = {
            itemId: item.id, itemName: item.name, quantity: qty, unitPrice: pricePrimary,
            totalAmount: pricePrimary * qty, profit, purchasePriceAtTime: item.purchasePrice,
            timestamp: Date.now(), saleCurrency: tempSellCurrency ? 'secondary' : 'primary'
        };
        try {
            item.quantity -= qty;
            await database.ref('items/' + item.id).set({
                name: item.name, purchasePrice: item.purchasePrice, salePrice: item.salePrice, quantity: item.quantity, updatedAt: Date.now()
            });
            const newSaleRef = await database.ref('sales').push(sale);
            sale.saleId = newSaleRef.key;
            items = items.map(i => i.id === item.id ? item : i);
            sales.unshift(sale);
            displayItems();
            updateStats();
            saveAllToLocalStorage();
            sellModal.style.display = 'none';
            updateConnectionStatus('online-status', 'ØªÙ… Ø§Ù„Ø¨ÙŠØ¹');
        } catch (e) { alert('ÙØ´Ù„ Ø§Ù„Ø¨ÙŠØ¹'); console.error(e); }
    });

    // -------------------- ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ¹ --------------------
    window.editSale = (saleId) => {
        historyModal.style.display = 'none';
        const sale = sales.find(s => s.saleId === saleId);
        if (!sale) return;
        const product = items.find(i => i.id === sale.itemId);
        if (!product) return alert('Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
        editSaleId.value = sale.saleId;
        editOriginalItemId.value = sale.itemId;
        editOriginalQuantity.value = sale.quantity;
        editSaleCurrency.value = sale.saleCurrency || 'primary';
        editProductName.innerText = sale.itemName;
        editQuantity.value = sale.quantity;
        editQuantity.max = product.quantity + sale.quantity;
        tempEditCurrency = (sale.saleCurrency === 'secondary');
        if (tempEditCurrency) {
            editPriceLabel.innerHTML = `Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© <small>(${currencySettings.secondaryCurrencySymbol})</small>`;
            editPrice.value = formatSecondary(convertToSecondary(sale.unitPrice));
            updateSecondaryEditPrice();
        } else {
            editPriceLabel.innerHTML = `Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© <small>($)</small>`;
            editPrice.value = sale.unitPrice;
            updateSecondaryEditPrice();
        }
        editPrice.oninput = updateSecondaryEditPrice;
        editSaleModal.style.display = 'flex';
    };

    function updateSecondaryEditPrice() {
        const val = parseFloat(editPrice.value) || 0;
        if (tempEditCurrency) {
            const primary = convertToPrimary(val);
            editPriceSecondaryInfo.innerText = `ØªØ¹Ø§Ø¯Ù„ $${formatPrimary(primary)}`;
        } else {
            const sec = convertToSecondary(val);
            editPriceSecondaryInfo.innerText = `ØªØ¹Ø§Ø¯Ù„ ${formatSecondary(sec)} ${currencySettings.secondaryCurrencySymbol}`;
        }
    }

    switchEditCurrency.addEventListener('click', () => {
        tempEditCurrency = !tempEditCurrency;
        const currentVal = parseFloat(editPrice.value) || 0;
        if (tempEditCurrency) {
            editPrice.value = Math.round(convertToSecondary(currentVal));
            editPriceLabel.innerHTML = `Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© <small>(${currencySettings.secondaryCurrencySymbol})</small>`;
        } else {
            editPrice.value = convertToPrimary(currentVal).toFixed(2);
            editPriceLabel.innerHTML = `Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© <small>($)</small>`;
        }
        updateSecondaryEditPrice();
    });

    editSaleForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const saleId = editSaleId.value;
        const itemId = editOriginalItemId.value;
        const oldQty = parseInt(editOriginalQuantity.value);
        const newQty = parseInt(editQuantity.value);
        let newPriceInPrimary;
        if (tempEditCurrency) {
            const sec = parseFloat(editPrice.value);
            if (isNaN(sec) || sec < 0) return alert('Ø³Ø¹Ø± ØºÙŠØ± ØµØ§Ù„Ø­');
            newPriceInPrimary = convertToPrimary(sec);
        } else {
            newPriceInPrimary = parseFloat(editPrice.value);
        }
        if (newQty <= 0 || newPriceInPrimary < 0) return alert('Ù‚ÙŠÙ… ØºÙŠØ± ØµØ§Ù„Ø­Ø©');
        const sale = sales.find(s => s.saleId === saleId);
        const product = items.find(i => i.id === itemId);
        if (!sale || !product) return;
        const diff = newQty - oldQty;
        if (diff > 0 && product.quantity < diff) return alert('Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
        try {
            product.quantity -= diff;
            await database.ref('items/' + product.id).set({
                name: product.name, purchasePrice: product.purchasePrice, salePrice: product.salePrice, quantity: product.quantity, updatedAt: Date.now()
            });
            const newTotal = newQty * newPriceInPrimary;
            const newProfit = (newPriceInPrimary - product.purchasePrice) * newQty;
            const updated = { ...sale, quantity: newQty, unitPrice: newPriceInPrimary, totalAmount: newTotal, profit: newProfit, saleCurrency: tempEditCurrency ? 'secondary' : 'primary' };
            await database.ref('sales/' + saleId).set(updated);
            items = items.map(i => i.id === product.id ? product : i);
            Object.assign(sale, updated);
            displayItems();
            updateStats();
            saveAllToLocalStorage();
            editSaleModal.style.display = 'none';
            updateConnectionStatus('online-status', 'ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
        } catch (e) { alert('ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'); console.error(e); }
    });

    // -------------------- Ø§Ù„Ø³Ø¬Ù„ ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª --------------------
    function displayActivityLog(filter = currentFilter) {
        let filtered = filter === 'all' ? activityLog : activityLog.filter(a => a.actionType === filter);
        if (!filtered.length) { historyTableBody.innerHTML = '<tr><td colspan="4" class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª</td></tr>'; return; }
        let html = '';
        filtered.forEach((act, idx) => {
            let typeTxt = { add:'Ø¥Ø¶Ø§ÙØ©', update:'ØªØ¹Ø¯ÙŠÙ„', delete:'Ø­Ø°Ù', quantity:'ØªØºÙŠÙŠØ± ÙƒÙ…ÙŠØ©', settings:'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª' }[act.actionType] || act.actionType;
            html += `<tr><td>${idx+1}</td><td>${act.dateTime || ''}</td><td>${typeTxt}</td><td>${act.details}</td></tr>`;
        });
        historyTableBody.innerHTML = html;
    }

    // Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ù‚Ø³Ù…Ø§Ù‹ Ø­Ø³Ø¨ Ø§Ù„ÙŠÙˆÙ… Ù…Ø¹ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ø³Ù… Ø§Ù„ÙŠÙˆÙ…
    function displaySalesLog() {
        if (!sales.length) { salesLogBody.innerHTML = '<tr><td colspan="7" class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª</td></tr>'; return; }
        
        // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙŠÙˆÙ… (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ù„ÙŠ YYYY-MM-DD)
        const grouped = {};
        sales.forEach(sale => {
            const d = new Date(sale.timestamp);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;
            if (!grouped[dateStr]) grouped[dateStr] = [];
            grouped[dateStr].push(sale);
        });

        // ØªØ±ØªÙŠØ¨ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® ØªÙ†Ø§Ø²Ù„ÙŠØ§Ù‹ (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
        const sortedDates = Object.keys(grouped).sort((a, b) => b.localeCompare(a));

        let html = '';
        sortedDates.forEach(dateStr => {
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„ÙŠÙˆÙ… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
            const dateObj = new Date(dateStr + 'T12:00:00'); // Ù†Ø¶Ø¹ ÙˆÙ‚Øª Ù…ØªÙˆØ³Ø· Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©
            const dayName = dateObj.toLocaleDateString('ar-EG', { weekday: 'long' });
            html += `<tr class="date-group-header"><td colspan="7">${dayName} ${dateStr}</td></tr>`;
            
            grouped[dateStr].forEach(s => {
                html += `<tr>
                    <td>${s.itemName}</td>
                    <td>${s.quantity}</td>
                    <td>$${formatPrimary(s.unitPrice)}</td>
                    <td>$${formatPrimary(s.totalAmount)}</td>
                    <td>$${formatPrimary(s.profit)}</td>
                    <td>${new Date(s.timestamp).toLocaleString('ar-EG')}</td>
                    <td>
                        <button class="action-btn edit" onclick="editSale('${s.saleId}')"><i class="fas fa-edit"></i></button>
                        <button class="action-btn delete" onclick="cancelSale('${s.saleId}')"><i class="fas fa-undo-alt"></i></button>
                    </td>
                </tr>`;
            });
        });
        salesLogBody.innerHTML = html;
    }

    window.cancelSale = async (saleId) => {
        if (!confirm('Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¨ÙŠØ¹ØŸ')) return;
        const sale = sales.find(s => s.saleId === saleId);
        if (!sale) return;
        const product = items.find(i => i.id === sale.itemId);
        if (!product) return alert('Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
        try {
            product.quantity += sale.quantity;
            await database.ref('items/' + product.id).set({ name: product.name, purchasePrice: product.purchasePrice, salePrice: product.salePrice, quantity: product.quantity, updatedAt: Date.now() });
            await database.ref('sales/' + saleId).remove();
            items = items.map(i => i.id === product.id ? product : i);
            sales = sales.filter(s => s.saleId !== saleId);
            displayItems(); updateStats(); saveAllToLocalStorage();
            if (historyModal.style.display === 'flex' && salesLogSection.style.display !== 'none') displaySalesLog();
            updateConnectionStatus('online-status', 'ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡');
        } catch (e) { alert('ÙØ´Ù„'); console.error(e); }
    };

    // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø³Ø¬Ù„
    reportTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            reportTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            const sectionId = tab.dataset.section;
            document.querySelectorAll('.report-section').forEach(s => s.classList.remove('active'));
            if (sectionId === 'profits') profitsSection.classList.add('active');
            else if (sectionId === 'inventory') inventorySection.classList.add('active');
            else if (sectionId === 'sales') salesLogSection.classList.add('active');
            else if (sectionId === 'activities') activityLogSection.classList.add('active');
            
            if (sectionId === 'sales') displaySalesLog();
            if (sectionId === 'activities') displayActivityLog(currentFilter);
            if (sectionId === 'profits' || sectionId === 'inventory') updateStats();
        });
    });

    // -------------------- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ¦Ø§Øª --------------------
    addCategoryBtn.addEventListener('click', async () => {
        const name = newCategoryName.value.trim();
        if (!name) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø©');
        try {
            const newCatRef = await database.ref('categories').push(name);
            categories.push({ id: newCatRef.key, name });
            renderCategoriesSelect();
            renderCategoriesList();
            newCategoryName.value = '';
            await addToActivityLog('settings', `Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© ${name}`);
        } catch (e) {
            alert('ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø©');
            console.error(e);
        }
    });

    // -------------------- Ø£Ø­Ø¯Ø§Ø« Ø¥Ø¶Ø§ÙÙŠØ© --------------------
    addItemBtn.addEventListener('click', addItem);
    settingsBtn.addEventListener('click', () => {
        settingsModal.style.display = 'flex';
        renderCategoriesList();
        renderSocialLinksList();
    });
    historyBtn.addEventListener('click', () => {
        historyModal.style.display = 'flex';
        updateStats();
        displaySalesLog();
        displayActivityLog(currentFilter);
    });
    storeStatusBtn.addEventListener('click', toggleStoreStatus);

    closeModal.addEventListener('click', () => itemModal.style.display = 'none');
    closeSellModal.addEventListener('click', () => sellModal.style.display = 'none');
    closeEditSaleModal.addEventListener('click', () => editSaleModal.style.display = 'none');
    closeHistoryModal.addEventListener('click', () => historyModal.style.display = 'none');
    closeSettingsModal.addEventListener('click', () => settingsModal.style.display = 'none');
    closeDetailsModal.addEventListener('click', () => productDetailsModal.style.display = 'none');
    cancelBtn.addEventListener('click', () => itemModal.style.display = 'none');
    cancelSellBtn.addEventListener('click', () => sellModal.style.display = 'none');
    cancelEditSaleBtn.addEventListener('click', () => editSaleModal.style.display = 'none');
    cancelSettingsBtn.addEventListener('click', () => settingsModal.style.display = 'none');

    purchasePrice.addEventListener('input', updateSecondaryPrices);
    salePrice.addEventListener('input', updateSecondaryPrices);
    sellPrice.addEventListener('input', updateSecondarySellPrice);
    editPrice.addEventListener('input', updateSecondaryEditPrice);

    searchInput.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        displayItems(items.filter(i => i.name.toLowerCase().includes(term)));
    });

    historyFilter.addEventListener('click', (e) => {
        if (e.target.classList.contains('history-filter-btn')) {
            document.querySelectorAll('.history-filter-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            currentFilter = e.target.dataset.action;
            displayActivityLog(currentFilter);
        }
    });

    clearHistoryBtn.addEventListener('click', async () => {
        if (confirm('Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ')) {
            try { await database.ref('activityLog').remove(); activityLog = []; saveAllToLocalStorage(); displayActivityLog(); } catch (e) { alert('ÙØ´Ù„'); }
        }
    });

    settingsForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const newSettings = {
            secondaryCurrencyName: document.getElementById('secondaryCurrencyName').value.trim(),
            secondaryCurrencySymbol: document.getElementById('secondaryCurrencySymbol').value.trim(),
            exchangeRate: parseFloat(document.getElementById('exchangeRate').value),
            defaultInputCurrency: document.querySelector('input[name="defaultInputCurrency"]:checked').value,
            defaultSellCurrency: document.querySelector('input[name="defaultSellCurrency"]:checked').value
        };
        if (!newSettings.secondaryCurrencyName || !newSettings.secondaryCurrencySymbol || isNaN(newSettings.exchangeRate) || newSettings.exchangeRate <= 0)
            return alert('Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
        try {
            await database.ref('currencySettings').set(newSettings);
            currencySettings = newSettings;
            await addToActivityLog('settings', 'ØªØºÙŠÙŠØ± Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø©');
            tempPurchaseCurrency = (currencySettings.defaultInputCurrency === 'secondary');
            tempSaleCurrency = (currencySettings.defaultInputCurrency === 'secondary');
            tempSellCurrency = (currencySettings.defaultSellCurrency === 'secondary');
            updatePriceLabels(); updateSecondaryPrices(); displayItems();
            
            await saveStoreInfo();
            
            settingsModal.style.display = 'none';
            updateConnectionStatus('online-status', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
        } catch (e) { alert('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸'); }
    });

    window.addEventListener('click', (e) => {
        if (e.target === itemModal) itemModal.style.display = 'none';
        if (e.target === sellModal) sellModal.style.display = 'none';
        if (e.target === editSaleModal) editSaleModal.style.display = 'none';
        if (e.target === historyModal) historyModal.style.display = 'none';
        if (e.target === settingsModal) settingsModal.style.display = 'none';
        if (e.target === productDetailsModal) productDetailsModal.style.display = 'none';
    });

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    async function init() {
        updateConnectionStatus('syncing-status', 'Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...');
        await fetchCurrencySettings();
        await fetchCategories();
        await fetchStoreInfo();
        await fetchItems();
        await fetchSales();
        await fetchActivityLog();
        updateConnectionStatus('online-status', 'ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„');
    }
    init();
</script>
</body>
</html>
